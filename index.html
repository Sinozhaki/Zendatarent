<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RENT LINKEDIN BY ZEN</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* iOS SYSTEM COLORS (Dark Mode) */
            --ios-bg: #000000;
            --ios-card: rgba(28, 28, 30, 0.75); /* Sistem secondary background dengan transparansi */
            --ios-glass-border: rgba(255, 255, 255, 0.08);
            
            --theme-blue: #0A84FF;
            --theme-green: #30D158;
            --theme-red: #FF453A;
            --theme-orange: #FF9F0A;
            --theme-dark: #1C1C1E; /* Secondary system background */
            --theme-gray-dark: #2C2C2E; /* Tertiary system background */
            --theme-gray: #8E8E93; /* System gray */
            --theme-gray-light: #3A3A3C; /* Quaternary system background */
            
            --text-main: #FFFFFF;
            --text-sec: rgba(235, 235, 245, 0.6); /* iOS secondary label */
            
            /* Animasi standar Apple */
            --ios-transition: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            /* Tipografi standar Human Interface Guidelines */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", "Helvetica Neue", Helvetica, Arial, sans-serif;
            
            /* TEMA BARU: Dark Base dengan Setup Gradient */
            background-color: #05050A;
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            letter-spacing: -0.2px; /* Tipografi Apple cenderung rapat */
            
            /* Setup untuk Floating Blur Glow */
            position: relative;
            overflow-x: hidden; 
        }

        /* --- FITUR BARU: FLOATING BLUR GLOW (Soft iOS Dark SaaS Style) --- */
        body::before, body::after {
            content: "";
            position: fixed;
            width: 350px;
            height: 350px;
            border-radius: 50%;
            z-index: -1;
            filter: blur(90px);
            opacity: 0.6;
            animation: floatGlow 15s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none; /* Mencegah elemen glow mengganggu klik tombol */
        }

        body::before {
            background: rgba(10, 132, 255, 0.25); /* Soft iOS Blue */
            top: -100px;
            left: -100px;
        }

        body::after {
            background: rgba(191, 90, 242, 0.2); /* Soft iOS Purple */
            bottom: -100px;
            right: -100px;
            animation-delay: -7s; /* Gerakan asimetris / tidak berbarengan */
        }

        @keyframes floatGlow {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(50px, 40px) scale(1.1); }
            100% { transform: translate(-30px, 80px) scale(0.9); }
        }
        /* --- END FLOATING BLUR GLOW --- */

        .app-container {
            width: 100%;
            max-width: 480px; 
            padding: 16px; 
            padding-bottom: 80px;
            position: relative;
            z-index: 1; /* Pastikan konten utama selalu di atas Glow */
        }

        /* --- WIDGET / GLASS CARD iOS STYLE --- */
        .glass-card {
            background: var(--ios-card);
            backdrop-filter: blur(40px); /* Efek blur kuat khas iOS */
            -webkit-backdrop-filter: blur(40px);
            border: 0.5px solid var(--ios-glass-border);
            border-radius: 20px; /* Radius melengkung standar widget */
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        }

        /* --- HEADER & TITLES --- */
        header { 
            text-align: center; 
            margin-bottom: 24px; 
            position: relative; 
        }

        .admin-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: transparent;
            border: none;
            color: var(--theme-blue); /* Action button warna biru iOS */
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            padding: 10px;
            transition: var(--ios-transition);
        }
        .admin-btn:active { transform: scale(0.85); opacity: 0.7; }
        
        .banner-img {
            width: 100%;
            border-radius: 16px;
            margin-bottom: 16px;
            object-fit: cover;
            border: 0.5px solid var(--ios-glass-border);
        }

        h1 { 
            font-weight: 700; 
            font-size: 1.6rem; 
            margin: 4px 0; 
            letter-spacing: -0.5px;
            color: var(--text-main);
        }

        .subtitle { 
            font-size: 0.85rem; 
            color: var(--theme-gray); 
            font-weight: 500; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }

        /* --- WARNING BOX (iOS Notification Style) --- */
        .warning-box {
            background: rgba(255, 69, 58, 0.1);
            border: 0.5px solid rgba(255, 69, 58, 0.2);
            border-radius: 16px;
            padding: 14px 16px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #fff;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            line-height: 1.4;
        }
        
        .warning-box i {
            color: var(--theme-red);
            font-size: 1.4rem;
            margin-top: 2px;
            animation: pulse-red 2.5s infinite;
        }

        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- INPUTS & FORMS --- */
        .form-group { margin-bottom: 14px; text-align: left; }
        
        label { 
            display: block; 
            font-size: 0.8rem; 
            color: var(--text-sec); 
            margin-bottom: 6px; 
            margin-left: 4px; 
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            background: var(--theme-gray-dark); /* Latar textfield iOS */
            border: 0.5px solid transparent;
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            transition: var(--ios-transition);
            caret-color: var(--theme-blue); /* Kursor biru iOS */
        }
        
        input::placeholder, select::placeholder, textarea::placeholder {
            color: var(--theme-gray);
        }
        
        input:focus { 
            background: var(--theme-gray-light);
            border-color: rgba(10, 132, 255, 0.5); 
        }
        
        input[type="date"] { 
            color-scheme: dark; 
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%;
            border: none;
            border-radius: 14px; /* Sudut tombol iOS */
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--ios-transition);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: #fff;
        }
        
        @media (hover: hover) {
            .btn:hover { filter: brightness(1.15); }
        }
        
        .btn:active { 
            opacity: 0.6; 
            transform: scale(0.96); 
        }
        
        .btn-primary { background: var(--theme-blue); }
        .btn-glow { 
            background: linear-gradient(135deg, #1C1C1E, #2C2C2E); 
            border: 0.5px solid var(--ios-glass-border);
            color: var(--theme-orange); 
        }
        .btn-sewa { background: var(--theme-gray-dark); }
        .btn-withdraw { background: var(--theme-blue); margin-top: 10px; }
        .btn-danger { background: var(--theme-red); }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; border-radius: 10px; width: auto; }
        .btn-wa { background: var(--theme-green); }
        .btn-done { background: var(--theme-blue); }
        
        .btn-skip { background: var(--theme-gray-dark); color: var(--text-sec); }
        .btn-reject { background: rgba(255, 69, 58, 0.15); color: var(--theme-red); border: 0.5px solid rgba(255, 69, 58, 0.3); }

        /* --- SWEETALERT CUSTOM STYLE (iOS Match) --- */
        .swal-dark-input {
            background: var(--theme-gray-dark) !important;
            color: #fff !important;
            border: none !important;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
        }
        .swal-dark-input:focus { background: var(--theme-gray-light) !important; }
        .swal-label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: var(--text-sec);
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* --- ANIMASI GLOW PULSE UNTUK STATUS --- */
        @keyframes softGlow {
            0% { opacity: 0.85; transform: scale(1); box-shadow: 0 0 4px currentColor; }
            50% { opacity: 1; transform: scale(1.02); box-shadow: 0 0 12px currentColor; }
            100% { opacity: 0.85; transform: scale(1); box-shadow: 0 0 4px currentColor; }
        }

        /* --- MODAL POPUP (iOS Style) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Overlay khas iOS */
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--ios-transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            width: 85%;
            max-width: 340px;
            max-height: 85vh; 
            overflow-y: auto; 
            background: rgba(30, 30, 30, 0.85); /* Tembus pandang di modal */
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 0.5px solid var(--ios-glass-border);
            border-radius: 24px;
            padding: 24px 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .close-modal-btn {
            position: absolute;
            top: 14px;
            right: 14px;
            background: var(--theme-gray-light);
            border: none;
            color: var(--theme-gray);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .close-modal-btn:active { background: var(--theme-gray); color: #fff; transform: scale(0.9); }

        /* --- STATUS BADGE --- */
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            background: var(--theme-gray-dark);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-size: 0.95rem; 
            border-bottom: 0.5px solid rgba(255,255,255,0.08); 
            padding-bottom: 10px; 
        }
        
        .data-val { 
            font-weight: 600; 
            color: #fff; 
            text-align: right; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            max-width: 60%; 
        }

        /* --- ADMIN PANEL LAYOUT --- */
        #adminPanel { display: none; }
        
        .admin-section { 
            margin-bottom: 20px; 
            border-top: 0.5px solid var(--ios-glass-border); 
            padding-top: 20px; 
        }
        
        .admin-title { 
            font-size: 1.1rem; 
            color: var(--text-main); 
            margin-bottom: 14px; 
            font-weight: 700; 
            letter-spacing: -0.3px;
        }
        
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 16px; 
        }
        
        .stat-box { 
            background: var(--theme-gray-dark); 
            padding: 14px 10px; 
            border-radius: 16px; 
            text-align: center;
        }
        
        .stat-num { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--theme-blue); 
        }
        
        .stat-label { 
            font-size: 0.7rem; 
            color: var(--text-sec); 
            margin-top: 4px;
            font-weight: 500;
        }
        
        /* --- USER LIST CARD (MANAGEMENT) --- */
        .user-manage-card {
            background: var(--theme-gray-dark);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 12px;
        }
        
        .um-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 10px; 
        }
        
        .um-email { 
            font-weight: 600; 
            color: #fff; 
            font-size: 0.9rem; 
            word-break: break-all; 
            max-width: 65%; 
        }
        
        .um-meta { 
            font-size: 0.8rem; 
            color: var(--theme-gray); 
            margin-bottom: 6px; 
            display:flex; 
            align-items:center; 
            gap:6px;
        }
        
        .um-actions { 
            display: flex; 
            gap: 8px; 
            margin-top: 12px; 
        }

        /* --- SINGLE CARD PAYMENT STYLE --- */
        .payment-focus-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 250px;
        }

        .payment-card-focus {
            background: var(--theme-gray-dark);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .pcf-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; padding-bottom: 16px; border-bottom: 0.5px solid rgba(255,255,255,0.08);
        }
        
        .pcf-queue {
            font-size: 0.75rem; font-weight: 700; color: var(--theme-blue); letter-spacing: 0.5px;
            background: rgba(10, 132, 255, 0.15); padding: 4px 10px; border-radius: 8px;
            display: inline-block; margin-bottom: 16px;
        }

        .pcf-amount { font-size: 1.6rem; font-weight: 700; color: #fff; }
        
        .pcf-row {
            display: flex; flex-direction: column; margin-bottom: 16px;
        }
        
        .pcf-label { font-size: 0.75rem; color: var(--theme-gray); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .pcf-val { font-size: 1.05rem; color: #fff; font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        
        .copy-btn {
            background: var(--theme-gray-light); border: none; color: var(--theme-blue);
            cursor: pointer; font-size: 0.8rem; margin-left: 10px; padding: 6px 10px; border-radius: 8px; font-weight: 600;
            transition: var(--ios-transition);
        }
        .copy-btn:active { transform: scale(0.9); opacity: 0.7; }
        
        .pcf-actions {
            display: flex; gap: 8px; margin-top: 24px; 
        }

        /* Nav Menu (iOS Segmented Control Style) */
        .nav-menu {
            display: flex; background: var(--theme-gray-dark); border-radius: 12px; padding: 4px;
            margin-bottom: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .nav-menu::-webkit-scrollbar { display: none; }
        .nav-btn {
            background: transparent; border: none; color: var(--text-sec);
            padding: 8px 16px; border-radius: 10px; font-size: 0.85rem; font-weight: 600; white-space: nowrap;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center;
        }
        .nav-btn.active { background: var(--theme-gray-light); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transform: scale(1.02); }

        .hidden { display: none !important; }
        
        /* ANIMASI KONTEN BARU (FADE & SLIDE UP) */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Kelas animasi berjenjang untuk List Data */
        .slide-up-item {
            opacity: 0;
            transform: translateY(15px);
            animation: slideUpFade 0.4s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }
        @keyframes slideUpFade {
            to { opacity: 1; transform: translateY(0); }
        }

        /* LIST SCAN RESULT STYLE */
        .scan-list-box {
            background: var(--theme-gray-dark);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
            border: 0.5px solid var(--ios-glass-border);
        }
        .scan-item {
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .scan-item input[type="checkbox"] {
            width: 18px; height: 18px; margin: 0;
        }
        .scan-item:last-child { border-bottom: none; }
        .tag-found { color: var(--theme-green); font-weight: 600; font-size: 0.75rem; margin-left: auto; }
        .tag-new { color: var(--theme-blue); font-weight: 600; font-size: 0.75rem; margin-left: auto; }

    </style>
</head>
<body>

<div class="app-container">
    
    <div id="userView" class="fade-in">
        <header>
            <button class="admin-btn" onclick="toggleAdminLogin()"><i class="fa-solid fa-wrench"></i></button>
            <img src="baner.gif" alt="Banner" class="banner-img" onerror="this.style.display='none'">
            <h1>RENT LINKEDIN BY ZEN</h1>
            <div class="subtitle">Web Official zen x 8800</div>
        </header>

        <a href="http://bonusrefferalbyzen.vercel.app/" target="_blank" class="btn btn-glow glass-card" style="margin-bottom: 12px; text-align: center;">
            <i class="fa-solid fa-gift" style="color: var(--theme-orange)"></i> EVENT REFFERAL x 8800
        </a>

        <a href="https://syaratketentuanbyzen.vercel.app/" target="_blank" class="btn glass-card" style="background: rgba(10, 132, 255, 0.15); color: var(--theme-blue); margin-bottom: 12px; text-align: center; border: 0.5px solid rgba(10, 132, 255, 0.3);">
            <i class="fa-solid fa-circle-info"></i> DETAIL SEWA
        </a>

        <a href="https://formsetorakun.vercel.app/" target="_blank" class="btn btn-sewa glass-card" style="margin-bottom: 24px; text-align: center;">
            <i class="fa-solid fa-rocket" style="color: var(--theme-blue)"></i> START SEWA
        </a>

        <div class="warning-box">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <div>
                <strong style="display:block; margin-bottom: 4px;">Penting</strong>
                Jangan pernah memberikan alamat email selain kepada client, admin, dan inviter untuk menghindari orang orang curang yang mau claim pay.
            </div>
        </div>
        
        <div class="glass-card">
            <h3 style="margin-top:0; margin-bottom: 16px; font-size:1.1rem; font-weight: 600; letter-spacing: -0.3px;"><i class="fa-solid fa-magnifying-glass" style="color: var(--theme-gray)"></i> Cek Status Akun</h3>
            <div class="form-group">
                <input type="email" id="userEmail" placeholder="Masukkan Email Anda...">
            </div>
            <button class="btn btn-primary" onclick="checkStatus()">Cari Status</button>
        </div>
    </div>

    <div id="statusModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal()">Ã—</button>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <span id="statusBadge" class="status-badge">STATUS</span>
            </div>
            
            <div class="data-row"><span>Email</span> <span class="data-val" id="resEmail">-</span></div>
            <div class="data-row"><span>WhatsApp</span> <span class="data-val" id="resWa">-</span></div>
            <div class="data-row"><span>Reward</span> <span class="data-val" id="resReward" style="color: var(--theme-blue)">-</span></div>
            
            <div id="withdrawSection" class="hidden slide-up-item" style="margin-top: 24px; padding-top: 20px; border-top: 0.5px solid var(--ios-glass-border);">
                <h4 style="margin:0 0 16px 0; color: #fff; text-align:center; font-weight: 600; font-size: 1.1rem;">Form Penarikan</h4>
                <div class="form-group">
                    <input type="text" id="wdName" placeholder="Atas Nama">
                </div>
                <div class="form-group">
                    <input type="text" id="wdBank" placeholder="Nama Bank / E-Wallet">
                </div>
                <div class="form-group">
                    <input type="number" id="wdRek" placeholder="Nomor Rekening">
                </div>
                <div class="form-group">
                    <input type="number" id="wdWA" placeholder="Nomor WhatsApp (Wajib)" style="border: 1px solid var(--theme-blue);">
                </div>
                <button class="btn btn-withdraw" onclick="submitWithdraw()">
                    Cairkan Reward
                </button>
            </div>
        </div>
    </div>

    <div id="adminPanel" style="display: none;">
        <header>
            <button class="admin-btn" onclick="logoutAdmin()" style="color: var(--theme-red)"><i class="fa-solid fa-right-from-bracket"></i></button>
            <h1>Admin Panel</h1>
            <div class="subtitle">Control Center</div>
        </header>

        <div class="nav-menu">
            <button class="nav-btn active" onclick="showFeature('home')"><i class="fa-solid fa-house"></i> Utama</button>
            <button class="nav-btn" onclick="showFeature('payment')"><i class="fa-solid fa-money-bill-transfer"></i> Pay</button>
            <button class="nav-btn" onclick="showFeature('mass')"><i class="fa-solid fa-layer-group"></i> Massal</button>
            <button class="nav-btn" onclick="showFeature('stats')"><i class="fa-solid fa-chart-simple"></i> Stats</button>
            <button class="nav-btn" onclick="showFeature('settings')"><i class="fa-solid fa-gear"></i> Set</button>
        </div>

        <div id="feature-home" class="admin-feature">
            <div class="glass-card">
                <div class="admin-title">Tambah Data Manual</div>
                <input type="email" id="addEmail" placeholder="Email" style="margin-bottom: 12px;">
                <input type="text" id="addWa" placeholder="WhatsApp" style="margin-bottom: 12px;">
                
                <select id="addStatus" style="margin-bottom: 12px;">
                    <option value="New Acc">New Acc</option>
                    <option value="Old Acc">Old Acc</option>
                    <option value="Unrestric">Unrestric</option>
                    <option value="New Acc Restric">New Acc Restric</option>
                    <option value="Restric">Restric</option>
                    <option value="Bonus Only">Bonus Only</option>
                    <option value="Lost Payment">Lost Payment</option>
                </select>

                <input type="text" id="addReward" placeholder="Reward (Rp)" style="margin-bottom: 12px;">
                
                <label style="margin-bottom: 6px;">Tanggal (Opsional):</label>
                <input type="date" id="addDate" style="margin-bottom: 20px;">
                
                <button class="btn btn-primary" onclick="addDataSingle()">Simpan Data</button>
            </div>

            <div class="glass-card admin-section">
                <div class="admin-title">Manajemen Data User</div>
                
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="searchUserInput" placeholder="Cari Email..." onkeyup="filterManageList()" style="flex: 1; margin-bottom: 0;">
                    
                    <select id="filterStatusInput" onchange="filterManageList()" style="flex: 1; margin-bottom: 0;">
                        <option value="ALL">Semua Status</option>
                        <option value="New Acc">New Acc</option>
                        <option value="Old Acc">Old Acc</option>
                        <option value="Unrestric">Unrestric</option>
                        <option value="New Acc Restric">New Acc Restric</option>
                        <option value="Restric">Restric</option>
                        <option value="Bonus Only">Bonus Only</option>
                        <option value="Lost Payment">Lost Payment</option>
                    </select>
                </div>

                <button class="btn btn-primary btn-sm" onclick="loadManageData()" style="width:100%; margin-bottom:16px;">Muat Ulang Data</button>
                
                <div id="manageListContainer" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
                    <p style="text-align: center; color: var(--theme-gray);">Klik "Muat Ulang Data" untuk melihat list.</p>
                </div>
            </div>
        </div>

        <div id="feature-payment" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Statistik Penarikan</div>
                <div class="stat-grid">
                    <div class="stat-box" style="background: rgba(255,159,10,0.15);">
                        <div class="stat-num" id="stat-pending" style="color: var(--theme-orange);">0</div>
                        <div class="stat-label" style="color: var(--theme-orange);">Menunggu</div>
                    </div>
                    <div class="stat-box" style="background: rgba(48,209,88,0.15);">
                        <div class="stat-num" id="stat-paid" style="color: var(--theme-green);">0</div>
                        <div class="stat-label" style="color: var(--theme-green);">Selesai</div>
                    </div>
                </div>
                <button class="btn btn-sm" onclick="resetPaymentHistory()" style="width: 100%; margin-top: 4px; background: rgba(255, 69, 58, 0.15); color: var(--theme-red); border: 0.5px solid rgba(255, 69, 58, 0.3);">
                    <i class="fa-solid fa-trash-can"></i> Reset Histori Selesai
                </button>
            </div>

            <div class="glass-card" style="background: transparent; border: none; padding: 0; box-shadow: none;">
                <div class="admin-title" style="padding-left: 4px;">Antrian Transfer</div>
                
                <div id="paymentFocusContainer" class="payment-focus-wrapper">
                    <p style="text-align:center; color:var(--theme-gray); margin-top:20px;">Memuat data...</p>
                </div>
                
                <button class="btn btn-primary btn-sm" onclick="loadPaymentTracking()" style="margin-top: 24px; background: var(--theme-gray-dark); color: #fff;">
                    <i class="fa-solid fa-rotate"></i> Refresh Antrian
                </button>
            </div>
        </div>

        <div id="feature-mass" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Identifikasi & Proses Massal</div>
                <label>Paste List Email (1 email per baris):</label>
                <textarea id="massInput" rows="8" style="margin-bottom: 14px; font-size: 0.85rem;" placeholder="email1@gmail.com&#10;email2@gmail.com"></textarea>
                
                <button class="btn btn-primary" onclick="scanMassData()">
                    <i class="fa-solid fa-magnifying-glass"></i> SCAN / IDENTIFIKASI DATA
                </button>

                <div id="scanResultArea" style="display:none; margin-top: 20px; animation: fadeIn 0.5s;">
                    
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; margin-bottom:16px;">
                        <div style="font-size:0.8rem; margin-bottom:8px; font-weight:600;">Setting untuk Proses:</div>
                        <select id="massStatus" style="margin-bottom: 8px;">
                            <option value="">-- Pilih Status Baru --</option>
                            <option value="New Acc">New Acc</option>
                            <option value="Old Acc">Old Acc</option>
                            <option value="Unrestric">Unrestric</option>
                            <option value="New Acc Restric">New Acc Restric</option>
                            <option value="Restric">Restric</option>
                            <option value="Bonus Only">Bonus Only</option>
                            <option value="Lost Payment">Lost Payment</option>
                        </select>
                        <input type="text" id="massReward" placeholder="Reward (Opsional)" style="margin-bottom: 8px;">
                        <input type="date" id="massDate">
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-weight:600; font-size:0.9rem; color:var(--theme-green);">Terdeteksi di Database (<span id="countFound">0</span>)</span>
                        </div>
                        <div id="listFound" class="scan-list-box"></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-sewa" onclick="execMassUpdate()" style="font-size:0.8rem;">Update Data Terdeteksi</button>
                            <button class="btn btn-danger" onclick="execMassDelete()" style="font-size:0.8rem;">Hapus Data Terdeteksi</button>
                        </div>
                    </div>

                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-weight:600; font-size:0.9rem; color:var(--theme-blue);">Email Belum Terdaftar (<span id="countNew">0</span>)</span>
                        </div>
                        <div id="listNew" class="scan-list-box"></div>
                        <button class="btn btn-primary" onclick="execMassInsert()" style="font-size:0.8rem;">Simpan Data Baru</button>
                    </div>

                </div>
            </div>

            <div class="glass-card" style="margin-top: 20px;">
                <div class="admin-title">Kelola Berdasarkan Status (DB)</div>
                <div style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">Fitur ini bekerja pada semua data yang sudah ada di database.</div>

                <div style="padding-bottom:16px; margin-bottom:16px; border-bottom:0.5px solid var(--ios-glass-border);">
                    <label>Salin Semua Email:</label>
                    <div style="display:flex; gap:8px;">
                        <select id="copyStatusTarget" style="margin-bottom:0;">
                            <option value="ALL">Semua Status</option>
                            <option value="New Acc">New Acc</option>
                            <option value="Old Acc">Old Acc</option>
                            <option value="Unrestric">Unrestric</option>
                            <option value="New Acc Restric">New Acc Restric</option>
                            <option value="Restric">Restric</option>
                            <option value="Bonus Only">Bonus Only</option>
                            <option value="Lost Payment">Lost Payment</option>
                        </select>
                        <button class="btn btn-primary" style="width:auto; padding:0 20px;" onclick="copyEmailsByStatus()">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label>Update Reward Massal:</label>
                    <select id="rewardStatusTarget" style="margin-bottom:10px;">
                        <option value="">-- Pilih Target Status --</option>
                        <option value="New Acc">New Acc</option>
                        <option value="Old Acc">Old Acc</option>
                        <option value="Unrestric">Unrestric</option>
                        <option value="New Acc Restric">New Acc Restric</option>
                        <option value="Restric">Restric</option>
                        <option value="Bonus Only">Bonus Only</option>
                        <option value="Lost Payment">Lost Payment</option>
                    </select>
                    <input type="number" id="massRewardValue" placeholder="Nominal Baru (Misal: 50000)" style="margin-bottom:12px;">
                    <button class="btn btn-danger" onclick="updateRewardByStatus()">
                        Update Reward Massal
                    </button>
                </div>
            </div>

        </div>

        <div id="feature-stats" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Statistik User</div>
                <div class="stat-grid" id="statsContainer">
                    <div class="stat-box"><div class="stat-num">...</div><div class="stat-label">Loading</div></div>
                </div>
                <button class="btn btn-primary" onclick="loadStats()">Refresh Stats</button>
            </div>
        </div>

        <div id="feature-settings" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Pengaturan Global</div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: var(--theme-gray-dark); padding: 14px 16px; border-radius: 14px;">
                    <span style="font-weight: 500;">Withdraw User</span>
                    <button id="wdSwitchBtn" class="btn" style="width: auto; padding: 6px 16px; font-size: 0.85rem; border-radius: 20px;" onclick="toggleWithdrawSwitch()">
                        Loading...
                    </button>
                </div>
            </div>
        </div>

    </div>

</div>

<script>
    // 1. SUPABASE CONFIGURATION
    const supabaseUrl = 'https://bllzoxlrqzzfkcnyhyad.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsbHpveGxycXp6ZmtjbnloeWFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTk0NzgsImV4cCI6MjA4NjEzNTQ3OH0.I1BVt8lJJKYXWOX-xBiOwiq3D3-PEN7hEHYJw-VKe9c';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Global Vars
    let currentUserData = null;
    let isWithdrawOpen = false;
    let allUsersCache = [];
    let paymentQueue = [];
    
    // Vars untuk Mass Scan
    let scannedFound = []; // Menyimpan objek user yg ketemu
    let scannedNew = []; // Menyimpan string email yg baru

    // FUNGSI ANIMASI UNTUK PERGANTIAN MENU TAB ADMIN
    function showFeature(featureName) {
        document.querySelectorAll('.admin-feature').forEach(el => {
            el.classList.add('hidden');
            el.classList.remove('fade-in'); // reset animasi
        });
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        
        const targetFeature = document.getElementById('feature-' + featureName);
        targetFeature.classList.remove('hidden');
        
        // Memicu (trigger) ulang animasi CSS fade-in
        void targetFeature.offsetWidth;
        targetFeature.classList.add('fade-in');

        const btnMap = { 'home':0, 'payment':1, 'mass':2, 'stats':3, 'settings':4 };
        const buttons = document.querySelectorAll('.nav-btn');
        if(buttons[btnMap[featureName]]) buttons[btnMap[featureName]].classList.add('active');
        
        if(featureName === 'home') loadManageData();
        if(featureName === 'payment') { loadPaymentTracking(); loadPaymentStats(); }
        if(featureName === 'stats') loadStats();
        if(featureName === 'settings') getWithdrawStatus();
    }

    function closeModal() {
        const modal = document.getElementById('statusModal');
        modal.classList.remove('active');
    }

    function getStatusColor(status) {
        if (!status) return { bg: 'rgba(255,255,255,0.05)', color: '#fff', shadow: '#fff' };
        
        const s = status.toLowerCase();
        
        if (s === 'new acc' || s === 'old acc') {
            return { bg: 'rgba(10, 132, 255, 0.2)', color: '#0A84FF', shadow: 'transparent' }; 
        }
        else if (s === 'unrestrict' || s === 'unrestric') { 
            return { bg: 'rgba(255, 255, 255, 0.1)', color: '#ffffff', shadow: 'transparent' }; 
        }
        else if (s === 'new acc restric' || s === 'restric new acc') { 
            return { bg: 'rgba(255, 159, 10, 0.2)', color: '#FF9F0A', shadow: 'transparent' }; 
        }
        else if (s.includes('restric') || s === 'bonus only') {
            return { bg: 'rgba(255, 69, 58, 0.2)', color: '#FF453A', shadow: 'transparent' }; 
        }
        else {
            return { bg: 'rgba(255, 255, 255, 0.1)', color: '#ffffff', shadow: 'transparent' };
        }
    }

    async function checkStatus() {
        const emailInput = document.getElementById('userEmail').value.trim();
        if (!emailInput) return Swal.fire({title:'Error', text:'Masukkan email terlebih dahulu', icon:'error', background:'#1C1C1E', color:'#fff'});

        Swal.fire({ title: 'Mengecek...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });
        await getWithdrawStatus();
        const { data, error } = await _supabase.from('linked_users').select('*').ilike('email', emailInput).single();
        Swal.close();

        if (error || !data) {
            Swal.fire({icon: 'error', title: 'Tidak Ditemukan', text: 'Email tidak terdaftar.', background: '#1C1C1E', color: '#fff'});
            return;
        }
        currentUserData = data;
        renderUserResult(data);
    }

    function renderUserResult(data) {
        const modal = document.getElementById('statusModal');
        const badge = document.getElementById('statusBadge');
        
        document.getElementById('resEmail').innerText = data.email;
        document.getElementById('resWa').innerText = data.whatsapp || '-';
        document.getElementById('resReward').innerText = data.reward ? `Rp ${data.reward}` : 'Rp 0';

        badge.innerText = data.status || 'UNKNOWN';
        
        const style = getStatusColor(data.status);
        badge.style.background = style.bg;
        badge.style.color = style.color;
        
        badge.style.border = `1px solid ${style.color}50`;
        badge.style.animation = `softGlow 2.5s infinite ease-in-out`;

        const wdSec = document.getElementById('withdrawSection');
        if (isWithdrawOpen && data.payment_status !== 'claimed' && data.payment_status !== 'paid' && data.payment_status !== 'rejected') {
            wdSec.classList.remove('hidden');
        } else if (data.payment_status === 'claimed' || data.payment_status === 'paid' || data.payment_status === 'rejected') {
            wdSec.classList.add('hidden');
            let msg = 'Permintaan sedang DIPROSES.';
            if (data.payment_status === 'paid') msg = 'Reward SUDAH DIBAYAR.';
            if (data.payment_status === 'rejected') msg = 'Permintaan DITOLAK.';
            
            Swal.fire({icon: 'info', title: 'Info Status', text: msg, background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
        } else {
            wdSec.classList.add('hidden');
        }

        modal.classList.add('active'); 
    }

    async function submitWithdraw() {
        const name = document.getElementById('wdName').value;
        const bank = document.getElementById('wdBank').value;
        const rek = document.getElementById('wdRek').value;
        const wa = document.getElementById('wdWA').value;

        if(!name || !bank || !rek || !wa) return Swal.fire({title: 'Gagal', text:'Lengkapi semua kolom termasuk WhatsApp.', icon:'warning', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
        Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });

        const { error } = await _supabase.from('linked_users').update({
            payment_status: 'claimed', acc_name: name, bank_name: bank, acc_number: rek, whatsapp: wa, withdraw_date: new Date().toISOString()
        }).eq('id', currentUserData.id);

        if (error) Swal.fire({title: 'Error', text: error.message, icon:'error', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
        else {
            Swal.fire({icon: 'success', title: 'Berhasil!', text: 'Permintaan penarikan terkirim.', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
            document.getElementById('withdrawSection').classList.add('hidden');
        }
    }

    async function getWithdrawStatus() {
        const { data } = await _supabase.from('app_settings').select('is_active').eq('setting_name', 'withdraw_feature').single();
        if (data) isWithdrawOpen = data.is_active; else isWithdrawOpen = true;
        updateAdminSwitchUI();
    }

    function toggleAdminLogin() {
        Swal.fire({
            title: 'Admin Access', input: 'password', inputPlaceholder: 'Masukkan Sandi', background: '#1C1C1E', color: '#fff', showCancelButton: true, confirmButtonColor: '#0A84FF', cancelButtonColor: '#3A3A3C'
        }).then((result) => {
            if (result.isConfirmed && btoa(result.value) === 'MjAwMw==') {
                document.getElementById('userView').classList.add('hidden');
                document.getElementById('adminPanel').style.display = 'block';
                
                // Memicu animasi fade-in admin panel pertama kali dibuka
                document.getElementById('adminPanel').classList.add('fade-in');

                showFeature('home'); getWithdrawStatus();
            } else if (result.isConfirmed) Swal.fire({title:'Akses Ditolak', text:'Sandi salah', icon:'error', background: '#1C1C1E', color: '#fff'});
        });
    }

    function logoutAdmin() {
        document.getElementById('adminPanel').style.display = 'none';
        const uView = document.getElementById('userView');
        uView.classList.remove('hidden');
        // Restart animasi user view
        void uView.offsetWidth;
        uView.classList.add('fade-in');
    }

    async function loadStats() {
        const { data, error } = await _supabase.from('linked_users').select('status');
        if(error) return;
        const counts = {};
        data.forEach(row => { const s = row.status || 'Unknown'; counts[s] = (counts[s] || 0) + 1; });
        const container = document.getElementById('statsContainer');
        container.innerHTML = `<div class="stat-box slide-up-item" style="grid-column: span 2; background: rgba(10, 132, 255, 0.15); animation-delay: 0s;"><div class="stat-num">${data.length}</div><div class="stat-label" style="color:var(--text-sec);">TOTAL DATA</div></div>`;
        
        let delayIndex = 1;
        for (const [key, val] of Object.entries(counts)) { 
            const animDelay = (delayIndex * 0.05).toFixed(2); // Stagger animation
            container.innerHTML += `<div class="stat-box slide-up-item" style="animation-delay: ${animDelay}s"><div class="stat-num">${val}</div><div class="stat-label">${key}</div></div>`; 
            delayIndex++;
        }
    }

    function updateAdminSwitchUI() {
        const btn = document.getElementById('wdSwitchBtn');
        if(isWithdrawOpen) { btn.innerText = 'Buka'; btn.style.background = 'var(--theme-green)'; btn.style.color = '#fff'; } 
        else { btn.innerText = 'Tutup'; btn.style.background = 'var(--theme-gray-light)'; btn.style.color = '#fff'; }
    }

    async function toggleWithdrawSwitch() {
        const newState = !isWithdrawOpen;
        const { error } = await _supabase.from('app_settings').update({ is_active: newState }).eq('setting_name', 'withdraw_feature');
        if(!error) { isWithdrawOpen = newState; updateAdminSwitchUI(); Swal.fire({title:'Sukses', text: newState ? 'Form Dibuka' : 'Form Ditutup', icon:'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'}); }
    }

    async function loadManageData() {
        const list = document.getElementById('manageListContainer'); list.innerHTML = '<p style="text-align:center; color: var(--theme-gray);">Loading...</p>';
        const { data, error } = await _supabase.from('linked_users').select('*').order('created_at', { ascending: false }).limit(500);
        if (error) { list.innerHTML = '<p style="text-align:center; color: var(--theme-red);">Gagal memuat data.</p>'; return; }
        allUsersCache = data; renderManageList(allUsersCache);
    }

    function renderManageList(dataArr) {
        const list = document.getElementById('manageListContainer');
        if (dataArr.length === 0) { list.innerHTML = '<p style="text-align:center; color:var(--theme-gray);">Kosong.</p>'; return; }
        
        const nonRestricData = dataArr.filter(item => !(item.status || '').toLowerCase().includes('restric'));
        const restricData = dataArr.filter(item => (item.status || '').toLowerCase().includes('restric'));
        const sortedData = [...nonRestricData, ...restricData];

        let html = '';
        sortedData.forEach((item, index) => {
            const style = getStatusColor(item.status);
            const animDelay = (index < 20) ? (index * 0.04).toFixed(2) : 0; 
            
            html += `<div class="user-manage-card slide-up-item" style="animation-delay: ${animDelay}s">
                        <div class="um-header">
                            <div class="um-email">${item.email}</div>
                            <div style="font-size:0.7rem; font-weight:600; background: ${style.bg}; padding:4px 10px; border-radius:12px; border:1px solid ${style.color}50; color: ${style.color} !important;">${item.status}</div>
                        </div>
                        <div class="um-meta"><i class="fa-brands fa-whatsapp"></i> ${item.whatsapp || '-'} | Rp ${item.reward || 0}</div>
                        <div class="um-meta" style="font-size:0.75rem; color:var(--theme-gray);">Date: ${new Date(item.created_at).toLocaleDateString()}</div>
                        <div class="um-actions">
                            <button class="btn btn-sm" style="background: var(--theme-blue); color:white;" onclick="editUser(${item.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${item.id})">Hapus</button>
                        </div>
                     </div>`;
        });
        list.innerHTML = html;
    }

    function filterManageList() {
        const q = document.getElementById('searchUserInput').value.toLowerCase();
        const statusFilter = document.getElementById('filterStatusInput').value;

        const filteredData = allUsersCache.filter(u => {
            const matchesSearch = (u.email && u.email.toLowerCase().includes(q)) || (u.status && u.status.toLowerCase().includes(q));
            
            const sRaw = u.status || '';
            const sDb = sRaw.toLowerCase().trim(); 
            const sFilter = statusFilter.toLowerCase().trim(); 

            const matchesStatus = statusFilter === 'ALL' || sDb === sFilter;

            return matchesSearch && matchesStatus;
        });

        renderManageList(filteredData);
    }

    async function deleteUser(id) {
        const res = await Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#FF453A', cancelButtonColor: '#3A3A3C', confirmButtonText: 'Hapus', background: '#1C1C1E', color: '#fff' });
        if (res.isConfirmed) { await _supabase.from('linked_users').delete().eq('id', id); loadManageData(); loadStats(); }
    }

    async function editUser(id) {
        const u = allUsersCache.find(x => x.id === id); if(!u) return;
        const { value: v } = await Swal.fire({
            title: 'Edit User', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF', cancelButtonColor: '#3A3A3C', showCancelButton: true,
            html: `
            <div style="text-align:left; margin-bottom:10px;">
                <label class="swal-label">Status</label>
                <select id="swal-s" class="swal-dark-input">
                    <option value="New Acc" ${u.status=='New Acc'?'selected':''}>New Acc</option>
                    <option value="Old Acc" ${u.status=='Old Acc'?'selected':''}>Old Acc</option>
                    <option value="Unrestric" ${u.status=='Unrestric'?'selected':''}>Unrestric</option>
                    <option value="New Acc Restric" ${u.status=='New Acc Restric'?'selected':''}>New Acc Restric</option>
                    <option value="Restric" ${u.status=='Restric'?'selected':''}>Restric</option>
                    <option value="Bonus Only" ${u.status=='Bonus Only'?'selected':''}>Bonus Only</option>
                    <option value="Lost Payment" ${u.status=='Lost Payment'?'selected':''}>Lost Payment</option>
                </select>
                <label class="swal-label">Reward (Rp)</label>
                <input id="swal-r" class="swal-dark-input" value="${u.reward||''}">
                <label class="swal-label">WhatsApp</label>
                <input id="swal-w" class="swal-dark-input" value="${u.whatsapp||''}">
            </div>`,
            preConfirm: () => ({ status: document.getElementById('swal-s').value, reward: document.getElementById('swal-r').value, whatsapp: document.getElementById('swal-w').value })
        });
        if (v) { await _supabase.from('linked_users').update(v).eq('id', id); loadManageData(); loadStats(); }
    }

    async function addDataSingle() {
        const e = document.getElementById('addEmail').value.trim(), w = document.getElementById('addWa').value, s = document.getElementById('addStatus').value, r = document.getElementById('addReward').value, d = document.getElementById('addDate').value;
        if(!e) return Swal.fire({title:'Error', text:'Email wajib.', icon:'warning', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
        const { data: ex } = await _supabase.from('linked_users').select('id').eq('email', e).single();
        if(ex) return Swal.fire({title:'Gagal', text:'Email sudah ada.', icon:'error', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
        const p = { email: e, whatsapp: w, status: s, reward: r }; if(d) p.created_at = new Date(d).toISOString();
        const { error } = await _supabase.from('linked_users').insert([p]);
        if(!error) { Swal.fire({title:'Sukses', text:'Data tersimpan.', icon:'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'}); document.getElementById('addEmail').value = ''; loadManageData(); loadStats(); }
    }

    // === FITUR BARU: MASS SCAN & PROSES DENGAN CHECKBOX & REGEX ===
    
    async function scanMassData() {
        const raw = document.getElementById('massInput').value;
        // REGEX FILTER: Hanya ambil string yang formatnya email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        const list = raw.split('\n')
            .map(x => x.trim())
            .filter(x => x !== '' && emailRegex.test(x)); // Filter di sini
        
        if(list.length === 0) return Swal.fire({title:'Kosong/Invalid', text:'Tidak ada email valid yang ditemukan.', icon:'warning', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
        
        Swal.fire({ title: 'Scanning...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });

        // Reset
        scannedFound = [];
        scannedNew = [];

        // Cek DB
        const { data: existingUsers, error } = await _supabase.from('linked_users').select('email, status, reward').in('email', list);
        
        if (error) {
            Swal.fire({title:'Error', text: error.message, icon:'error', background: '#1C1C1E', color: '#fff'});
            return;
        }

        // Pisahkan Data
        const foundEmails = existingUsers.map(u => u.email.toLowerCase());
        scannedFound = existingUsers; // Simpan objek lengkap untuk keperluan update
        scannedNew = list.filter(e => !foundEmails.includes(e.toLowerCase()));

        // Tampilkan UI Hasil
        document.getElementById('scanResultArea').style.display = 'block';
        document.getElementById('countFound').innerText = scannedFound.length;
        document.getElementById('countNew').innerText = scannedNew.length;

        // Render List Found (DENGAN CHECKBOX)
        const listFoundEl = document.getElementById('listFound');
        listFoundEl.innerHTML = scannedFound.length ? '' : '<div style="padding:10px; text-align:center; color:#555;">Tidak ada data ditemukan</div>';
        scannedFound.forEach(u => {
            listFoundEl.innerHTML += `<div class="scan-item">
                <input type="checkbox" class="chk-found" value="${u.email}" checked>
                <span>${u.email}</span>
                <span class="tag-found">${u.status} | ${u.reward}</span>
            </div>`;
        });

        // Render List New (DENGAN CHECKBOX)
        const listNewEl = document.getElementById('listNew');
        listNewEl.innerHTML = scannedNew.length ? '' : '<div style="padding:10px; text-align:center; color:#555;">Tidak ada email baru</div>';
        scannedNew.forEach(email => {
            listNewEl.innerHTML += `<div class="scan-item">
                <input type="checkbox" class="chk-new" value="${email}" checked>
                <span>${email}</span>
                <span class="tag-new">New</span>
            </div>`;
        });

        Swal.close();
    }

    async function execMassUpdate() {
        // AMBIL HANYA YANG DICENTANG
        const checkboxes = document.querySelectorAll('.chk-found:checked');
        const emailsToUpdate = Array.from(checkboxes).map(cb => cb.value);

        if (emailsToUpdate.length === 0) return Swal.fire({title:'Kosong', text:'Pilih (centang) data yang ingin diupdate.', icon:'warning', background: '#1C1C1E', color: '#fff'});

        const s = document.getElementById('massStatus').value;
        const r = document.getElementById('massReward').value;
        
        if (!s && !r) return Swal.fire({title:'Info', text:'Pilih Status atau Reward baru di form atas.', icon:'info', background: '#1C1C1E', color: '#fff'});

        const confirm = await Swal.fire({
            title: 'Update Massal?',
            text: `Akan mengupdate ${emailsToUpdate.length} data terpilih.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Update',
            confirmButtonColor: '#0A84FF',
            background: '#1C1C1E', color: '#fff'
        });

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Updating...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });
            
            const updates = {};
            if(s) updates.status = s;
            if(r) updates.reward = r;

            const { error } = await _supabase.from('linked_users').update(updates).in('email', emailsToUpdate);

            if (!error) {
                Swal.fire({title:'Sukses', text:'Data berhasil diupdate.', icon:'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
                loadManageData(); loadStats(); scanMassData(); // Rescan untuk lihat hasil
            } else {
                Swal.fire({title:'Gagal', text:error.message, icon:'error', background: '#1C1C1E', color: '#fff'});
            }
        }
    }

    async function execMassDelete() {
        // AMBIL HANYA YANG DICENTANG
        const checkboxes = document.querySelectorAll('.chk-found:checked');
        const emailsToDelete = Array.from(checkboxes).map(cb => cb.value);

        if (emailsToDelete.length === 0) return Swal.fire({title:'Kosong', text:'Pilih (centang) data yang ingin dihapus.', icon:'warning', background: '#1C1C1E', color: '#fff'});

        const confirm = await Swal.fire({
            title: 'Hapus Massal?',
            text: `Yakin menghapus ${emailsToDelete.length} data terpilih?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Hapus',
            confirmButtonColor: '#FF453A',
            background: '#1C1C1E', color: '#fff'
        });

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Deleting...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });
            
            const { error } = await _supabase.from('linked_users').delete().in('email', emailsToDelete);

            if (!error) {
                Swal.fire({title:'Sukses', text:'Data berhasil dihapus.', icon:'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
                loadManageData(); loadStats(); scanMassData(); // Rescan
            }
        }
    }

    async function execMassInsert() {
        // AMBIL HANYA YANG DICENTANG
        const checkboxes = document.querySelectorAll('.chk-new:checked');
        const emailsToInsert = Array.from(checkboxes).map(cb => cb.value);

        if (emailsToInsert.length === 0) return Swal.fire({title:'Kosong', text:'Pilih (centang) email baru yang ingin disimpan.', icon:'warning', background: '#1C1C1E', color: '#fff'});

        const s = document.getElementById('massStatus').value;
        const r = document.getElementById('massReward').value || '0';
        const d = document.getElementById('massDate').value;

        if (!s) return Swal.fire({title:'Info', text:'Pilih Status awal untuk data baru di form atas.', icon:'info', background: '#1C1C1E', color: '#fff'});

        const confirm = await Swal.fire({
            title: 'Simpan Massal?',
            text: `Akan menyimpan ${emailsToInsert.length} data baru terpilih.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ya, Simpan',
            confirmButtonColor: '#30D158',
            background: '#1C1C1E', color: '#fff'
        });

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Saving...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });
            
            const newPayload = emailsToInsert.map(email => ({
                email: email,
                status: s,
                reward: r,
                created_at: d ? new Date(d).toISOString() : new Date().toISOString()
            }));

            const { error } = await _supabase.from('linked_users').insert(newPayload);

            if (!error) {
                Swal.fire({title:'Sukses', text:'Data baru berhasil disimpan.', icon:'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
                loadManageData(); loadStats(); scanMassData(); // Rescan
            } else {
                Swal.fire({title:'Gagal', text:error.message, icon:'error', background: '#1C1C1E', color: '#fff'});
            }
        }
    }

    async function loadPaymentStats() {
        const { count: pendingCount } = await _supabase.from('linked_users').select('*', { count: 'exact', head: true }).eq('payment_status', 'claimed');
        const { count: paidCount } = await _supabase.from('linked_users').select('*', { count: 'exact', head: true }).eq('payment_status', 'paid');
        document.getElementById('stat-pending').innerText = pendingCount || 0;
        document.getElementById('stat-paid').innerText = paidCount || 0;
    }

    // FITUR BARU: FUNGSI RESET HISTORI PAYMENT
    async function resetPaymentHistory() {
        const res = await Swal.fire({
            title: 'Reset Histori?',
            text: 'Data yang sudah "Selesai" akan dihapus dari statistik ini.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#FF453A',
            cancelButtonColor: '#3A3A3C',
            confirmButtonText: 'Ya, Reset',
            background: '#1C1C1E', color: '#fff'
        });

        if (res.isConfirmed) {
            Swal.fire({ title: 'Mereset...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });
            
            // Status diubah menjadi "archived" agar tidak menumpuk di hitungan "Selesai"
            const { error } = await _supabase.from('linked_users').update({ payment_status: 'archived' }).eq('payment_status', 'paid');
            
            if (error) {
                Swal.fire({title: 'Error', text: error.message, icon: 'error', background: '#1C1C1E', color: '#fff'});
            } else {
                Swal.fire({title: 'Sukses', text: 'Histori Selesai berhasil direset.', icon: 'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
                loadPaymentStats(); // Refresh statistik
            }
        }
    }

    async function loadPaymentTracking() {
        const container = document.getElementById('paymentFocusContainer');
        container.innerHTML = '<p style="text-align:center;color:var(--theme-gray);">Loading...</p>';
        loadPaymentStats();
        
        const { data, error } = await _supabase
            .from('linked_users')
            .select('*')
            .eq('payment_status', 'claimed')
            .order('withdraw_date', { ascending: true }); 
            
        if(error || !data || data.length === 0) {
            container.innerHTML = '<p class="slide-up-item" style="text-align:center; color:var(--theme-gray); margin-top:30px;">Tidak ada antrian transfer.</p>';
            paymentQueue = [];
            return;
        }

        paymentQueue = data;
        renderActivePayment();
    }

    function renderActivePayment() {
        const container = document.getElementById('paymentFocusContainer');
        
        if (paymentQueue.length === 0) {
            container.innerHTML = '<p class="slide-up-item" style="text-align:center; color:var(--theme-gray); margin-top:30px;">Semua antrian selesai! ðŸŽ‰</p>';
            return;
        }

        const x = paymentQueue[0];
        
        let wn = (x.whatsapp||'').replace(/\D/g,''); 
        if(wn.startsWith('0')) wn='62'+wn.slice(1); 
        if(!wn.startsWith('62')) wn='62'+wn;

        const date = new Date(x.withdraw_date).toLocaleDateString();
        const msg = `Halo, Penarikan reward LinkedIn senilai Rp ${x.reward} ke ${x.bank_name} (${x.acc_number}) a.n ${x.acc_name} SUDAH BERHASIL DITRANSFER. Terima kasih telah bekerjasama dengan Zen!`;
        const waLink = `https://wa.me/${wn}?text=${encodeURIComponent(msg)}`;
        
        container.innerHTML = `
            <div class="payment-card-focus slide-up-item">
                <div class="pcf-queue">Antrian Priority</div>
                <div class="pcf-header">
                    <span class="pc-bank-badge" style="font-size:0.9rem; font-weight:600;">${x.bank_name}</span>
                    <div class="pcf-amount">Rp ${x.reward}</div>
                </div>
                <div class="pcf-row">
                    <div class="pcf-label"><i class="fa-solid fa-user"></i> Nama Pemilik</div>
                    <div class="pcf-val">${x.acc_name}</div>
                </div>
                <div class="pcf-row">
                    <div class="pcf-label"><i class="fa-solid fa-credit-card"></i> Nomor Rekening</div>
                    <div class="pcf-val">${x.acc_number} <button onclick="copyText('${x.acc_number}')" class="copy-btn"><i class="fa-regular fa-copy"></i> Salin</button></div>
                </div>
                <div class="pcf-row">
                    <div class="pcf-label"><i class="fa-solid fa-envelope"></i> Email User</div>
                    <div class="pcf-val" style="font-size:0.85rem; font-weight:400; color:var(--text-sec);">${x.email}</div>
                </div>
                <div class="pcf-actions" style="gap:8px;">
                     <button onclick="rejectPayment(${x.id}, '${wn}', ${x.reward})" class="btn btn-reject" style="flex:1; font-size:0.85rem; padding:12px;">Tolak</button>
                    <button onclick="skipPayment()" class="btn btn-skip" style="flex:1; font-size:0.85rem; padding:12px;">Lewati</button>
                    <button onclick="markAsPaid(${x.id}, '${waLink}')" class="btn btn-done" style="flex:2; font-size:0.85rem; padding:12px;">Transfer</button>
                </div>
                <div style="text-align:center; font-size:0.75rem; color:var(--theme-gray); margin-top:20px;">Request Tgl: ${date} (Sisa Antrian: ${paymentQueue.length})</div>
            </div>
        `;
    }

    function skipPayment() {
        if(paymentQueue.length > 1) {
            const item = paymentQueue.shift();
            paymentQueue.push(item);
            
            // Animasi reload card
            const container = document.getElementById('paymentFocusContainer');
            container.classList.remove('fade-in');
            void container.offsetWidth; // trigger reflow
            container.classList.add('fade-in');

            renderActivePayment();
        } else {
            Swal.fire({toast: true, position: 'center', icon: 'info', title: 'Hanya ada 1 antrian', showConfirmButton: false, timer: 1000, background: '#1C1C1E', color: '#fff'});
        }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, background: '#1C1C1E', color: '#fff'});
            Toast.fire({icon: 'success', title: 'Disalin!'});
        });
    }

    async function rejectPayment(id, waNum, amount) {
        const { value: reason } = await Swal.fire({
            title: 'Tolak Penarikan?',
            input: 'text',
            inputLabel: 'Alasan Penolakan',
            inputPlaceholder: 'Misal: Nomor rekening salah...',
            showCancelButton: true,
            confirmButtonColor: '#FF453A',
            cancelButtonColor: '#3A3A3C',
            confirmButtonText: 'Tolak & WA',
            background: '#1C1C1E', color: '#fff',
            inputValidator: (value) => { if (!value) return 'Alasan wajib diisi!' }
        });

        if (reason) {
            const { error } = await _supabase.from('linked_users').update({ payment_status: 'rejected' }).eq('id', id);
            if(error) { Swal.fire({title:'Error', text:error.message, icon:'error', background: '#1C1C1E', color: '#fff'}); return; }
            
            const msg = `Halo, Maaf permintaan penarikan reward Rp ${amount} DITOLAK. Alasan: ${reason}. Silakan cek data Anda kembali.`;
            const link = `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`;
            window.open(link, '_blank');
            
            paymentQueue.shift();
            
            // Render ulang dengan animasi
            const container = document.getElementById('paymentFocusContainer');
            container.classList.remove('fade-in');
            void container.offsetWidth;
            container.classList.add('fade-in');

            renderActivePayment();
            loadPaymentStats();
        }
    }

    async function markAsPaid(id, waLink) {
        const result = await Swal.fire({
            title: 'Konfirmasi Transfer', text: "Pastikan dana sudah dikirim sebelum menekan Ya.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Sudah Transfer', confirmButtonColor: '#0A84FF', cancelButtonColor: '#3A3A3C', background: '#1C1C1E', color: '#fff'
        });

        if (result.isConfirmed) {
            const finishedItem = paymentQueue.shift(); 
            
            const { error } = await _supabase.from('linked_users').update({ payment_status: 'paid' }).eq('id', id);
            if (error) { 
                Swal.fire({title:'Error', text:error.message, icon:'error', background: '#1C1C1E', color: '#fff'}); 
            } else { 
                window.open(waLink, '_blank'); 
                loadPaymentStats(); 
                
                // Render ulang dengan animasi
                const container = document.getElementById('paymentFocusContainer');
                container.classList.remove('fade-in');
                void container.offsetWidth;
                container.classList.add('fade-in');
                
                renderActivePayment(); 
            }
        }
    }

    // --- FITUR BARU: COPY EMAILS BY STATUS ---
    async function copyEmailsByStatus() {
        const target = document.getElementById('copyStatusTarget').value;
        
        Swal.fire({ title: 'Menyalin...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });
        
        let query = _supabase.from('linked_users').select('email');
        if (target !== 'ALL') {
            query = query.eq('status', target);
        }
        
        const { data, error } = await query;
        
        if (error) {
            Swal.fire({title:'Error', text:error.message, icon:'error', background: '#1C1C1E', color: '#fff'});
            return;
        }

        if (!data || data.length === 0) {
            Swal.fire({title:'Kosong', text:'Tidak ada data untuk status ini.', icon:'info', background: '#1C1C1E', color: '#fff'});
            return;
        }

        // Ambil list email, join dengan newline
        const emailList = data.map(u => u.email).join('\n');
        
        navigator.clipboard.writeText(emailList).then(() => {
            Swal.fire({title:'Sukses', text:`${data.length} email berhasil disalin!`, icon:'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
        });
    }

    // --- FITUR BARU: UPDATE REWARD MASSAL BY STATUS ---
    async function updateRewardByStatus() {
        const target = document.getElementById('rewardStatusTarget').value;
        const amount = document.getElementById('massRewardValue').value;
        
        if (!target) return Swal.fire({title:'Pilih Status', text:'Pilih status target terlebih dahulu.', icon:'warning', background: '#1C1C1E', color: '#fff'});
        if (!amount) return Swal.fire({title:'Isi Nominal', text:'Isi nominal reward baru.', icon:'warning', background: '#1C1C1E', color: '#fff'});

        const confirm = await Swal.fire({
            title: 'Yakin Update Massal?',
            text: `Semua user dengan status "${target}" akan diubah reward-nya menjadi Rp ${amount}. Tindakan ini tidak bisa dibatalkan!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Ubah Semua',
            confirmButtonColor: '#FF453A',
            cancelButtonColor: '#3A3A3C',
            background: '#1C1C1E', color: '#fff'
        });

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading(), background: '#1C1C1E', color: '#fff' });
            
            const { error } = await _supabase.from('linked_users')
                .update({ reward: amount })
                .eq('status', target);
                
            if (error) {
                Swal.fire({title:'Error', text: error.message, icon:'error', background: '#1C1C1E', color: '#fff'});
            } else {
                Swal.fire({title:'Berhasil', text:'Reward berhasil diupdate secara massal.', icon:'success', background: '#1C1C1E', color: '#fff', confirmButtonColor: '#0A84FF'});
                loadManageData(); // Refresh list jika sedang melihatnya
            }
        }
    }

</script>
</body>
</html>
