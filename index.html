<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RENT LINKEDIN BY ZEN</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* iOS SYSTEM COLORS (Light Mode) */
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.85);
            --ios-glass-border: rgba(0, 0, 0, 0.08);
            
            --theme-blue: #0A84FF;
            --theme-green: #34C759;
            --theme-red: #FF3B30;
            --theme-orange: #FF9500;
            --theme-dark: #FFFFFF; 
            --theme-gray-dark: #E5E5EA; 
            --theme-gray: #8E8E93;
            --theme-gray-light: #D1D1D6;
            
            --text-main: #000000;
            --text-sec: rgba(60, 60, 67, 0.6);
            
            --ios-transition: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            letter-spacing: -0.2px;
            position: relative;
            overflow-x: hidden; 
        }

        /* --- FLOATING BLUR GLOW --- */
        body::before, body::after {
            content: "";
            position: fixed;
            width: 350px;
            height: 350px;
            border-radius: 50%;
            z-index: -1;
            filter: blur(90px);
            opacity: 0.4; 
            animation: floatGlow 15s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        body::before {
            background: rgba(10, 132, 255, 0.35);
            top: -100px; left: -100px;
        }

        body::after {
            background: rgba(191, 90, 242, 0.3);
            bottom: -100px; right: -100px;
            animation-delay: -7s;
        }

        @keyframes floatGlow {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(50px, 40px) scale(1.1); }
            100% { transform: translate(-30px, 80px) scale(0.9); }
        }

        .app-container {
            width: 100%;
            max-width: 480px; 
            padding: 16px; 
            padding-bottom: 80px;
            position: relative;
            z-index: 1;
        }

        /* --- GLASS CARD --- */
        .glass-card {
            background: var(--ios-card);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 0.5px solid var(--ios-glass-border);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06); 
        }

        /* --- HEADER --- */
        header { 
            text-align: center; 
            margin-bottom: 24px; 
            position: relative; 
        }

        .admin-btn {
            position: absolute; top: 0; right: 0;
            background: transparent; border: none;
            color: var(--theme-blue); font-size: 1.2rem;
            cursor: pointer; z-index: 10; padding: 10px;
            transition: var(--ios-transition);
        }
        .admin-btn:active { transform: scale(0.85); opacity: 0.7; }
        
        .banner-img {
            width: 100%; border-radius: 16px; margin-bottom: 16px;
            object-fit: cover; border: 0.5px solid var(--ios-glass-border);
            aspect-ratio: 16/9; 
            display: block;
        }

        h1 { 
            font-weight: 700; font-size: 1.6rem; margin: 4px 0; 
            letter-spacing: -0.5px; color: var(--text-main);
        }

        .subtitle { 
            font-size: 0.85rem; color: var(--theme-gray); 
            font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* --- WARNING BOX --- */
        .warning-box {
            background: rgba(255, 59, 48, 0.1);
            border: 0.5px solid rgba(255, 59, 48, 0.2);
            border-radius: 16px; padding: 14px 16px;
            margin-bottom: 20px; font-size: 0.85rem; color: var(--text-main);
            display: flex; align-items: flex-start; gap: 12px; line-height: 1.4;
        }
        
        .warning-box i {
            color: var(--theme-red); font-size: 1.4rem; margin-top: 2px;
            animation: pulse-red 2.5s infinite;
        }

        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- INPUTS --- */
        .form-group { 
            margin-bottom: 14px; 
            text-align: left; 
            position: relative;
        }
        
        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--theme-gray);
            font-size: 1.1rem;
            z-index: 10;
            pointer-events: none;
            transition: all var(--ios-transition);
        }

        .form-group:focus-within .input-icon {
            color: var(--theme-blue);
            transform: translateY(-50%) scale(1.15);
            filter: drop-shadow(0 0 5px rgba(10,132,255,0.2));
        }

        .form-group:focus-within input {
            background: #fff !important;
            box-shadow: 0 4px 15px rgba(10,132,255,0.08) !important;
            border-color: var(--theme-blue) !important;
        }

        label { 
            display: block; font-size: 0.8rem; color: var(--text-sec); 
            margin-bottom: 6px; margin-left: 4px; font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%; background: var(--theme-gray-dark);
            border: 0.5px solid transparent; border-radius: 12px;
            padding: 14px; color: var(--text-main); font-family: inherit;
            font-size: 1rem; outline: none; transition: var(--ios-transition);
            caret-color: var(--theme-blue);
        }

        .form-group input { padding-left: 48px !important; }
        
        input::placeholder, select::placeholder, textarea::placeholder { color: var(--theme-gray); }
        input[type="date"] { color-scheme: light; }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; border: none; border-radius: 14px;
            padding: 14px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all var(--ios-transition);
            display: flex; justify-content: center; align-items: center;
            gap: 8px; text-decoration: none; color: var(--text-main);
        }
        
        @media (hover: hover) { .btn:hover { filter: brightness(0.95); } }
        
        .btn:active { opacity: 0.6; transform: scale(0.96); }
        
        .btn-primary { background: var(--theme-blue); color: #fff !important; }
        .btn-glow { background: linear-gradient(135deg, #FFFFFF, #F2F2F7); border: 0.5px solid var(--ios-glass-border); color: var(--theme-orange); }
        .btn-sewa { background: var(--theme-gray-dark); }
        .btn-withdraw { background: var(--theme-blue); color: #fff !important; margin-top: 10px; }
        .btn-danger { background: var(--theme-red); color: #fff !important; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; border-radius: 10px; width: auto; }
        .btn-wa { background: var(--theme-green); color: #fff !important; }
        .btn-done { background: var(--theme-blue); color: #fff !important; }
        .btn-skip { background: var(--theme-gray-light); color: var(--text-sec); }
        .btn-reject { background: rgba(255, 59, 48, 0.15); color: var(--theme-red); border: 0.5px solid rgba(255, 59, 48, 0.3); }

        /* --- SWEETALERT --- */
        .swal-dark-input {
            background: var(--theme-gray-dark) !important;
            color: var(--text-main) !important; border: none !important;
            border-radius: 10px; padding: 12px; margin-bottom: 15px;
            width: 100%; box-sizing: border-box;
            font-family: inherit; font-size: 1rem; outline: none;
        }
        .swal-dark-input:focus { background: var(--theme-dark) !important; box-shadow: inset 0 0 0 1px var(--theme-blue) !important; }
        .swal-label { display: block; text-align: left; margin-bottom: 5px; color: var(--text-sec); font-size: 0.85rem; font-weight: 500; }

        /* --- MODAL POPUP (GLASS ID CARD STYLE) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            opacity: 0; visibility: hidden; transition: opacity var(--ios-transition);
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-content {
            width: 90%; max-width: 380px; max-height: 85vh; overflow-y: auto;
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(40px) !important;
            -webkit-backdrop-filter: blur(40px) !important;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 36px; padding: 30px 24px;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.15), inset 0 0 0 1px rgba(255,255,255,0.5);
            transform: scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; text-align: center;
        }

        .modal-overlay.active .modal-content { transform: scale(1); }

        .close-modal-btn {
            position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.05); border: none;
            color: var(--text-main); width: 32px; height: 32px; border-radius: 50%; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; z-index: 5;
        }
        .close-modal-btn:active { background: rgba(0,0,0,0.1); transform: scale(0.9); }

        /* ID CARD ELEMENTS */
        .id-avatar-wrapper { position: relative; width: 80px; height: 80px; margin: 0 auto 16px auto; }
        .id-avatar {
            width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, rgba(10,132,255,0.1), rgba(10,132,255,0.02));
            border: 1px solid rgba(10,132,255,0.2); display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: var(--theme-blue); box-shadow: 0 10px 20px rgba(10,132,255,0.15);
        }
        .id-status-pill {
            display: inline-block; padding: 6px 16px; border-radius: 50px; font-size: 0.75rem; font-weight: 800; letter-spacing: 1px;
            text-transform: uppercase; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .reward-card-container {
            background: linear-gradient(135deg, var(--theme-blue), #5E5CE6); border-radius: 18px; padding: 20px; color: #fff;
            position: relative; overflow: hidden; margin-bottom: 24px; box-shadow: 0 10px 24px rgba(10, 132, 255, 0.25); text-align: left;
        }
        .rc-label { font-size: 0.8rem; font-weight: 500; opacity: 0.9; margin-bottom: 6px; }
        .rc-value { font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .rc-bg-pattern {
            position: absolute; top: -40px; right: -40px; width: 140px; height: 140px;
            background: radial-gradient(circle, rgba(255,255,255,0.25) 10%, transparent 10%), radial-gradient(circle, rgba(255,255,255,0.25) 10%, transparent 10%);
            background-size: 20px 20px; background-position: 0 0, 10px 10px; border-radius: 50%; pointer-events: none;
        }
        .id-info-bubble { background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); border-radius: 16px; padding: 12px 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; text-align: left; }
        .id-info-icon { width: 32px; height: 32px; border-radius: 10px; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; color: var(--theme-blue); }
        .id-info-text { display: flex; flex-direction: column; overflow: hidden; }
        .id-info-label { font-size: 0.7rem; color: var(--text-sec); margin-bottom: 2px; }
        .id-info-value { font-size: 0.95rem; font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .progress-tracker { display: flex; justify-content: space-between; position: relative; margin: 20px 0; padding: 0 10px; }
        .pt-line { position: absolute; top: 12px; left: 15%; right: 15%; height: 2px; background: rgba(0,0,0,0.1); z-index: 1; }
        .pt-line-fill { position: absolute; top: 0; left: 0; height: 100%; background: var(--theme-blue); width: 0%; transition: 0.8s ease-out; }
        .pt-step { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; gap: 6px; width: 33%; }
        .pt-icon { width: 26px; height: 26px; border-radius: 50%; background: var(--theme-gray-light); color: #fff; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; transition: 0.4s; box-shadow: 0 0 0 4px rgba(255,255,255,1); }
        .pt-step.active .pt-icon { background: var(--theme-blue); box-shadow: 0 0 0 4px rgba(255,255,255,1), 0 0 15px rgba(10,132,255,0.4); animation: pt-pulse 1.5s infinite; }
        .pt-step.done .pt-icon { background: var(--theme-green); box-shadow: 0 0 0 4px rgba(255,255,255,1); }
        .pt-step.rejected .pt-icon { background: var(--theme-red); box-shadow: 0 0 0 4px rgba(255,255,255,1); }
        .pt-label { font-size: 0.7rem; color: var(--text-sec); font-weight: 600; text-align: center; }
        .pt-step.active .pt-label { color: var(--theme-blue); }
        .pt-step.done .pt-label { color: var(--theme-green); }
        .pt-step.rejected .pt-label { color: var(--theme-red); }
        
        @keyframes pt-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .locked-mode { position: relative; border: 2px dashed rgba(52,199,89,0.5); border-radius: 16px; padding: 20px 16px 12px 16px; background: rgba(52,199,89,0.03); margin-bottom: 16px; margin-top: 20px; }
        .locked-overlay { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--theme-green); color: #fff; padding: 4px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(52,199,89,0.3); z-index: 10; }
        .form-section-title { font-size: 0.85rem; font-weight: 700; color: var(--text-main); margin-bottom: 12px; text-align: left; padding-bottom: 6px; border-bottom: 1px solid rgba(0,0,0,0.05); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- ADMIN PANEL CSS --- */
        .user-manage-card { background: var(--theme-gray-dark); border-radius: 16px; padding: 14px; margin-bottom: 12px; }
        .um-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .um-email { font-weight: 600; color: var(--text-main); font-size: 0.9rem; word-break: break-all; max-width: 65%; }
        .um-meta { font-size: 0.8rem; color: var(--theme-gray); margin-bottom: 6px; display:flex; align-items:center; gap:6px; }
        .um-actions { display: flex; gap: 8px; margin-top: 12px; }

        /* =======================================
           SARAN 1, 3, 4, 5 : PAYMENT CARD CSS
           ======================================= */
        .payment-focus-wrapper { position: relative; min-height: 420px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* Progress Bar Antrian */
        .queue-progress-text { text-align: center; font-size: 0.85rem; font-weight: 700; color: var(--text-sec); margin-bottom: 8px; }
        .queue-progress-container { width: 100%; background: rgba(0,0,0,0.06); border-radius: 10px; height: 10px; margin-bottom: 24px; overflow: hidden; position: relative; }
        .queue-progress-bar { height: 100%; background: linear-gradient(90deg, var(--theme-blue), #5E5CE6); border-radius: 10px; transition: width 0.6s cubic-bezier(0.25, 0.1, 0.25, 1); }
        
        /* Card Stack Styles */
        .payment-card-focus { background: var(--theme-gray-dark); border-radius: 20px; padding: 24px; width: 100%; position: absolute; z-index: 3; transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .payment-card-next { position: absolute; top: 15px; left: 2.5%; width: 95%; background: var(--theme-gray-dark); border-radius: 20px; height: 100%; z-index: 2; transform: scale(0.95); opacity: 0.6; pointer-events: none; border: 1px solid rgba(0,0,0,0.05); }
        .payment-card-next-2 { position: absolute; top: 30px; left: 5%; width: 90%; background: var(--theme-gray-dark); border-radius: 20px; height: 100%; z-index: 1; transform: scale(0.9); opacity: 0.3; pointer-events: none; }
        
        /* Animations Swipe & Stamp */
        .stamp-status { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(5) rotate(-15deg); font-size: 3.5rem; font-weight: 900; padding: 10px 20px; border-radius: 16px; opacity: 0; pointer-events: none; z-index: 10; text-transform: uppercase; letter-spacing: 2px; border: 6px solid; }
        @keyframes stampAnim { 0% { opacity: 0; transform: translate(-50%, -50%) scale(3) rotate(-15deg); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(-15deg); } 80% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(-15deg); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5) rotate(-15deg); } }
        
        .slide-out-right { transform: translateX(120%) rotate(10deg); opacity: 0; }
        .slide-out-left { transform: translateX(-120%) rotate(-10deg); opacity: 0; }
        .slide-out-bottom { transform: translateY(100%); opacity: 0; }

        /* Bank Colors Badges */
        .bank-bca { background: #0066AE !important; color: #fff !important; }
        .bank-dana { background: #118EEA !important; color: #fff !important; }
        .bank-ovo { background: #4C2A86 !important; color: #fff !important; }
        .bank-gopay { background: #00A550 !important; color: #fff !important; }
        .bank-mandiri { background: #003D79 !important; color: #fff !important; }
        .bank-bri { background: #00529C !important; color: #fff !important; }
        .bank-bni { background: #005E6A !important; color: #fff !important; }
        .bank-seabank { background: #FF6600 !important; color: #fff !important; }
        .bank-default { background: var(--theme-gray) !important; color: #fff !important; }

        .pcf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
        .pcf-queue { font-size: 0.75rem; font-weight: 700; color: var(--theme-blue); letter-spacing: 0.5px; background: rgba(10, 132, 255, 0.15); padding: 4px 10px; border-radius: 8px; display: inline-block; margin-bottom: 16px; }
        .pcf-amount { font-size: 1.6rem; font-weight: 700; color: var(--text-main); }
        .pcf-row { display: flex; flex-direction: column; margin-bottom: 16px; }
        .pcf-label { font-size: 0.75rem; color: var(--theme-gray); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .pcf-val { font-size: 1.05rem; color: var(--text-main); font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        .copy-btn { background: var(--theme-gray-light); border: none; color: var(--theme-blue); cursor: pointer; font-size: 0.8rem; margin-left: 10px; padding: 6px 10px; border-radius: 8px; font-weight: 600; transition: var(--ios-transition); }
        .copy-btn:active { transform: scale(0.9); opacity: 0.7; }
        .pcf-actions { display: flex; gap: 8px; margin-top: 24px; }

        /* --- BULK PAYMENT CSS --- */
        .bulk-item-row { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .bulk-chk { width: 20px; height: 20px; margin-top: 4px; accent-color: var(--theme-blue); }
        .bulk-info { flex: 1; font-size: 0.85rem; }
        .bulk-bank { font-weight: 700; color: var(--theme-orange); font-size: 0.75rem; display:block; margin-bottom:2px;}
        .bulk-name { font-weight: 600; color: var(--text-main); display:block; }
        .bulk-rek { color: var(--theme-gray); font-size: 0.75rem; }
        .bulk-amount { font-weight: 700; color: var(--theme-green); font-size: 0.9rem; margin-left:auto; white-space: nowrap;}
        
        .badge-dupe { background: rgba(52, 199, 89, 0.2); color: #34C759; border: 1px solid rgba(52, 199, 89, 0.3); font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 6px; display: inline-flex; align-items: center; gap: 4px; transition: 0.2s; }
        .badge-dupe:hover { background: rgba(52, 199, 89, 0.4); transform: scale(1.05); }

        /* --- WELCOME PAGE CSS --- */
        #welcomeOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--ios-bg); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; transition: opacity 0.5s ease-out; }
        #welcomeContent { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; z-index: 2; }
        .welcome-title { font-size: 2rem; font-weight: 800; color: var(--text-main); margin-bottom: 10px; letter-spacing: -1px; text-shadow: 0 0 30px rgba(10, 132, 255, 0.2); }
        .welcome-sub { font-size: 1rem; color: var(--text-sec); margin-bottom: 24px; max-width: 300px; line-height: 1.5; }

        /* --- ADMIN TITLE & NAV --- */
        .admin-title { font-size: 1.1rem; color: var(--text-main); margin-bottom: 14px; font-weight: 700; letter-spacing: -0.3px; }
        .nav-menu { display: flex; background: var(--theme-gray-dark); border-radius: 12px; padding: 4px; margin-bottom: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .nav-menu::-webkit-scrollbar { display: none; }
        .nav-btn { background: transparent; border: none; color: var(--text-sec); padding: 8px 16px; border-radius: 10px; font-size: 0.85rem; font-weight: 600; white-space: nowrap; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center; }
        .nav-btn.active { background: var(--theme-dark); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.1); transform: scale(1.02); }
        .admin-section { margin-bottom: 20px; border-top: 0.5px solid var(--ios-glass-border); padding-top: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-box { background: var(--theme-gray-dark); padding: 14px 10px; border-radius: 16px; text-align: center; }
        .stat-num { font-size: 1.5rem; font-weight: 700; color: var(--theme-blue); }
        .stat-label { font-size: 0.7rem; color: var(--text-sec); margin-top: 4px; font-weight: 500; }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up-item { opacity: 0; transform: translateY(15px); animation: slideUpFade 0.4s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; }
        @keyframes slideUpFade { to { opacity: 1; transform: translateY(0); } }
        .scan-list-box { background: var(--theme-gray-dark); border-radius: 16px; padding: 16px; margin-bottom: 16px; max-height: 200px; overflow-y: auto; border: 0.5px solid var(--ios-glass-border); }
        .scan-item { font-size: 0.85rem; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 8px 0; display: flex; align-items: center; gap: 10px; }
        .scan-item input[type="checkbox"] { width: 18px; height: 18px; margin: 0; }
        .scan-item:last-child { border-bottom: none; }
        .tag-found { color: var(--theme-green); font-weight: 600; font-size: 0.75rem; margin-left: auto; }
        .tag-new { color: var(--theme-blue); font-weight: 600; font-size: 0.75rem; margin-left: auto; }

        /* --- ANIMASI & WEB 3.0 STYLES --- */
        @keyframes floatUp { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes heartbeatCard { 0% { transform: scale(1); } 5% { transform: scale(1.02); } 10% { transform: scale(1); } 15% { transform: scale(1.02); } 50% { transform: scale(1); } 100% { transform: scale(1); } }
        @keyframes liquidFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .btn-liquid-gold { background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700); background-size: 200% auto; color: #000 !important; border: none !important; font-weight: 700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); animation: liquidFlow 3s linear infinite, floatUp 3s ease-in-out infinite; }
        .btn-liquid-blue { background: linear-gradient(90deg, #0A84FF, #00FFFF, #0A84FF); background-size: 200% auto; color: #fff !important; border: none !important; font-weight: 700; box-shadow: 0 0 15px rgba(10, 132, 255, 0.3); animation: liquidFlow 3s linear infinite, floatUp 3.5s ease-in-out infinite; animation-delay: 0s, 0.3s; }
        .btn-liquid-aurora { background: linear-gradient(90deg, #00C9FF, #92FE9D, #FF00CC, #00C9FF); background-size: 300% 100%; border: none !important; color: #fff !important; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 0 25px rgba(0, 201, 255, 0.4); animation: liquidFlow 4s ease-in-out infinite, floatUp 4s ease-in-out infinite; animation-delay: 0s, 0.6s; padding: 18px !important; font-size: 1.1rem !important; }
        .warning-heartbeat { animation: heartbeatCard 3s infinite ease-in-out; }

        @keyframes shineMove { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        .btn-blue-running { background: linear-gradient(110deg, #0A84FF 30%, #ffffff 45%, #0A84FF 60%); background-size: 250% 100%; animation: shineMove 3.5s linear infinite; color: #fff !important; border: none !important; font-weight: 700; box-shadow: 0 0 20px rgba(10, 132, 255, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-linkedin { background: #0A66C2 !important; color: #fff !important; border: none !important; box-shadow: 0 4px 15px rgba(10, 102, 194, 0.3) !important; transition: all 0.3s ease; font-weight: 700; }
        .btn-linkedin i { color: #fff !important; }
        .btn-linkedin:hover { background: #004182 !important; }

        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .bento-item { margin-bottom: 0 !important; height: 100%; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .hero-search-box { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(50px); border: 1px solid rgba(10, 132, 255, 0.2); border-radius: 24px; padding: 20px; margin-bottom: 24px; text-align: center; transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); position: relative; overflow: hidden; }
        .hero-search-box:focus-within { background: rgba(10, 132, 255, 0.05); border-color: var(--theme-blue); box-shadow: 0 0 40px rgba(10, 132, 255, 0.15); transform: scale(1.02); }
        .hero-search-input { background: rgba(255,255,255,0.8) !important; border: 1px solid rgba(0,0,0,0.05) !important; text-align: center; font-size: 1.1rem !important; padding: 16px !important; }
        .hero-search-input:focus { background: #fff !important; border-color: var(--theme-blue) !important; }

        /* --- HISTORY CSS --- */
        .hist-item { padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .hist-item:last-child { border-bottom: none; }
        .hist-header { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; }
        .hist-date { color: var(--theme-gray); }
        .hist-status { font-weight: 700; text-transform: uppercase; font-size: 0.7rem; }
        .hist-status.paid { color: var(--theme-green); }
        .hist-status.rejected { color: var(--theme-red); }
        .hist-name { font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .hist-bank { font-size: 0.8rem; color: var(--theme-orange); margin-right: 6px; }
        .hist-amount { color: var(--text-main); font-weight: 700; float: right; }

        /* --- PATTERN LOCK CSS --- */
        #adminLoginOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); backdrop-filter: blur(15px); z-index: 10002; justify-content: center; align-items: center; flex-direction: column; }
        .pattern-container { position: relative; width: 300px; height: 300px; background: rgba(0,0,0,0.03); border-radius: 24px; display: grid; grid-template-columns: repeat(3, 1fr); padding: 20px; gap: 0; touch-action: none; }
        .p-dot { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .p-dot-inner { width: 16px; height: 16px; background: rgba(0,0,0,0.1); border-radius: 50%; transition: 0.3s; pointer-events: none; }
        .p-dot.active .p-dot-inner { background: var(--theme-blue); box-shadow: 0 0 15px var(--theme-blue); transform: scale(1.5); }
        #patternSvg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .p-line { stroke: var(--theme-blue); stroke-width: 4; stroke-linecap: round; opacity: 0.8; filter: drop-shadow(0 0 5px var(--theme-blue)); }

        /* --- BULLETIN BOARD STYLES --- */
        .bulletin-container { margin-bottom: 20px; }
        .bulletin-card { background: rgba(10, 132, 255, 0.08); border: 0.5px solid rgba(10, 132, 255, 0.2); border-radius: 18px; padding: 14px 16px; display: flex; gap: 12px; align-items: flex-start; backdrop-filter: blur(20px); cursor: pointer; transition: transform 0.2s ease, background 0.2s ease; }
        .bulletin-card:active { transform: scale(0.98); background: rgba(10, 132, 255, 0.15); }
        .bulletin-icon { background: var(--theme-blue); color: white; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(10, 132, 255, 0.2); }
        .bulletin-content { flex: 1; }
        .bulletin-fade { animation: textFade 0.5s ease-in-out; }
        @keyframes textFade { 0% { opacity: 0; transform: translateY(5px); } 100% { opacity: 1; transform: translateY(0); } }
        .bulletin-title { font-size: 0.7rem; font-weight: 800; color: var(--theme-blue); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
        .bulletin-text { font-size: 0.85rem; line-height: 1.4; color: var(--text-main); }
        .bulletin-date { font-size: 0.65rem; color: var(--theme-gray); margin-top: 6px; display: block; }
        .admin-bulletin-item { background: var(--theme-gray-dark); padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 0.5px solid var(--ios-glass-border); }
        .bulletin-thumbnail { width: 80px; height: 80px; border-radius: 12px; margin-top: 10px; display: none; object-fit: cover; border: 1px solid rgba(0,0,0,0.05); cursor: zoom-in; transition: transform 0.2s ease; }
        .bulletin-thumbnail:active { transform: scale(0.95); }
        .all-bulletins-list { display: flex; flex-direction: column; gap: 12px; text-align: left; }
        .bulletin-item-full { background: rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.05); border-radius: 12px; padding: 14px; }
    </style>
</head>
<body>

<audio id="bgMusic" src="musik.mp3" loop></audio>

<div id="adminLoginOverlay">
    <div style="text-align:center; margin-bottom:20px; color:var(--text-main);">
        <h2 style="margin:0; font-weight:800; letter-spacing:-0.5px;">ADMIN ACCESS</h2>
        <p style="margin:5px 0 0 0; font-size:0.9rem; color:var(--text-sec);">Gambar Pola Kunci</p>
    </div>
    <div class="pattern-container" id="patternGrid">
        <svg id="patternSvg"></svg>
    </div>
    <button class="btn btn-sm" onclick="closeAdminLogin()" style="margin-top:30px; background:rgba(0,0,0,0.05); color:var(--text-main); width:auto; border-radius:50px; padding:10px 24px;">
        <i class="fa-solid fa-xmark"></i> Batal
    </button>
</div>

<div id="welcomeOverlay">
    <img id="welcomeImg" src="baner.gif" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 0 40px rgba(10, 132, 255, 0.3); margin-bottom: 24px;">
    
    <div id="welcomeContent">
        <div class="welcome-title">RENT LINKEDIN</div>
        <div class="welcome-sub" style="margin-bottom: 24px;">Platform sewa akun LinkedIn aman & terpercaya by Zen x 8800</div>
        
        <div class="warning-box warning-heartbeat" style="text-align: left; max-width: 320px; margin-bottom: 32px;">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <div>
                <strong style="display:block; margin-bottom: 4px;">Penting</strong>
                Jangan pernah memberikan alamat email selain kepada client, admin, dan inviter untuk menghindari orang curang.
            </div>
        </div>
        
        <button onclick="enterApp()" class="btn btn-blue-running" style="width: auto; padding: 16px 40px !important; border-radius: 50px; margin: 0 auto;">
            LANJUTKAN <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>
        </button>
    </div>
</div>

<div class="app-container" style="display: none; opacity: 0;"> <div id="userView" class="fade-in">
        <header>
            <button class="admin-btn" onclick="openAdminPattern()"><i class="fa-solid fa-wrench"></i></button>
            <img src="baner.gif" alt="Banner" class="banner-img" onerror="this.style.display='none'">
            <h1>RENT LINKEDIN BY ZEN</h1>
            <div class="subtitle">Web Official zen x 8800</div>
        </header>

        <div id="bulletinArea" class="bulletin-container hidden">
            <div class="bulletin-card" onclick="openAllBulletinsModal()">
                <div class="bulletin-icon"><i class="fa-solid fa-bullhorn"></i></div>
                <div class="bulletin-content" id="bulletinContentSlider">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="bulletin-title">Papan Buletin</div>
                        <div style="font-size:0.6rem; color:var(--theme-blue); background:rgba(10,132,255,0.15); padding:2px 6px; border-radius:10px;">Lihat Semua</div>
                    </div>
                    <div id="bulletinText" class="bulletin-text">Memuat informasi...</div>
                    <img id="bulletinImgDisplay" src="" class="bulletin-thumbnail" onclick="event.stopPropagation(); openImageModal(this.src)">
                    <span id="bulletinDate" class="bulletin-date"></span>
                </div>
            </div>
        </div>

        <div class="hero-search-box">
            <h3 style="margin-top:0; margin-bottom: 12px; font-size:1.1rem; font-weight: 600; letter-spacing: -0.3px; color:var(--text-main);">
                <i class="fa-solid fa-magnifying-glass" style="color: var(--theme-blue)"></i> Cek Status Akun
            </h3>
            <div class="form-group" style="margin-bottom: 12px;">
                <input type="email" id="userEmail" class="hero-search-input" placeholder="Masukkan Email Anda...">
            </div>
            <button class="btn btn-primary" onclick="checkStatus()" style="width:100%; border-radius:12px;">Cari Status</button>
        </div>

        <div class="bento-grid">
            <a href="http://bonusrefferalbyzen.vercel.app/" target="_blank" class="btn glass-card btn-linkedin bento-item">
                <i class="fa-solid fa-gift" style="font-size: 1.5rem; margin-bottom: 4px;"></i>
                <span style="font-size: 0.8rem;">EVENT REFFERAL</span>
            </a>
            <a href="https://syaratketentuanbyzen.vercel.app/" target="_blank" class="btn glass-card btn-linkedin bento-item">
                <i class="fa-solid fa-circle-info" style="font-size: 1.5rem; margin-bottom: 4px;"></i>
                <span style="font-size: 0.8rem;">DETAIL SEWA</span>
            </a>
        </div>

        <a href="https://formsetorakun.vercel.app/" target="_blank" class="btn glass-card btn-linkedin" style="margin-bottom: 24px; text-align: center; padding: 18px !important; font-size: 1.1rem !important; letter-spacing: 1px;">
            <i class="fa-solid fa-rocket"></i> START SEWA
        </a>

    </div>

    <div id="statusModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal()">Ã—</button>
            
            <div class="id-avatar-wrapper">
                <div class="id-avatar" id="statusAvatar">
                    <i class="fa-solid fa-user"></i>
                </div>
            </div>
            
            <div id="statusBadge" class="id-status-pill">STATUS</div>

            <div class="reward-card-container">
                <div class="rc-label">Total Reward</div>
                <div class="rc-value" id="resReward">Rp 0</div>
                <div class="rc-bg-pattern"></div>
            </div>

            <div class="id-info-bubble">
                <div class="id-info-icon"><i class="fa-solid fa-envelope"></i></div>
                <div class="id-info-text">
                    <span class="id-info-label">Email Terdaftar</span>
                    <span class="id-info-value" id="resEmail">-</span>
                </div>
            </div>
            
            <div id="progressTrackerSection" class="hidden slide-up-item" style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.02); border-radius: 16px; border: 1px solid rgba(0,0,0,0.05);">
                <h4 style="margin: 0 0 16px 0; font-size: 0.9rem; font-weight: 700; color: var(--text-main);">Status Penarikan</h4>
                <div class="progress-tracker">
                    <div class="pt-line"><div class="pt-line-fill" id="ptLineFill"></div></div>
                    <div class="pt-step" id="ptStep1">
                        <div class="pt-icon"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                        <div class="pt-label">Klaim</div>
                    </div>
                    <div class="pt-step" id="ptStep2">
                        <div class="pt-icon"><i class="fa-solid fa-user-gear"></i></div>
                        <div class="pt-label">Diproses</div>
                    </div>
                    <div class="pt-step" id="ptStep3">
                        <div class="pt-icon" id="ptStep3Icon"><i class="fa-solid fa-check-double"></i></div>
                        <div class="pt-label" id="ptStep3Label">Selesai</div>
                    </div>
                </div>
            </div>

            <div id="withdrawSection" class="hidden slide-up-item" style="margin-top: 10px;">
                
                <div id="lockedBankGroup">
                    <div id="lockedOverlay" class="locked-overlay" style="display:none;">
                        <i class="fa-solid fa-lock"></i> Data Terkunci Aman
                    </div>
                    <div class="form-section-title">Informasi Rekening</div>
                    
                    <div class="form-group">
                        <i class="fa-solid fa-user input-icon"></i>
                        <input type="text" id="wdName" placeholder="Atas Nama">
                    </div>
                    <div class="form-group">
                        <i class="fa-solid fa-building-columns input-icon"></i>
                        <input type="text" id="wdBank" placeholder="Nama Bank / E-Wallet">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <i class="fa-solid fa-credit-card input-icon"></i>
                        <input type="number" id="wdRek" placeholder="Nomor Rekening">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="form-section-title">Kontak Validasi</div>
                    <div class="form-group">
                        <i class="fa-brands fa-whatsapp input-icon" style="color:var(--theme-green);"></i>
                        <input type="number" id="wdWA" placeholder="Nomor WhatsApp (Wajib)" style="border: 1px solid var(--theme-green);">
                    </div>
                </div>
                
                <button class="btn btn-withdraw" onclick="submitWithdraw()" style="margin-top: 24px;">
                    Cairkan Reward
                </button>

                <button class="btn" onclick="requestDataChange()" style="margin-top: 12px; background: transparent; border: 1px solid var(--theme-gray-light); color: var(--text-sec); font-size: 0.85rem;">
                    <i class="fa-solid fa-pen-to-square"></i> Ajukan Ubah Data Rekening
                </button>
            </div>
        </div>
    </div>

    <div id="adminPanel" style="display: none;">
        <header>
            <button class="admin-btn" onclick="logoutAdmin()" style="color: var(--theme-red)"><i class="fa-solid fa-right-from-bracket"></i></button>
            <h1>Admin Panel</h1>
            <div class="subtitle">Control Center</div>
        </header>

        <div class="nav-menu">
            <button class="nav-btn active" onclick="showFeature('home')"><i class="fa-solid fa-house"></i> Utama</button>
            <button class="nav-btn" onclick="showFeature('payment')"><i class="fa-solid fa-money-bill-transfer"></i> Pay</button>
            <button class="nav-btn" onclick="showFeature('mass')"><i class="fa-solid fa-layer-group"></i> Massal</button>
            <button class="nav-btn" onclick="showFeature('bulletin')"><i class="fa-solid fa-bullhorn"></i> Papan</button>
            <button class="nav-btn" onclick="showFeature('stats')"><i class="fa-solid fa-chart-simple"></i> Stats</button>
            <button class="nav-btn" onclick="showFeature('settings')"><i class="fa-solid fa-gear"></i> Set</button>
        </div>

        <div id="feature-home" class="admin-feature">
            <div class="glass-card">
                <div class="admin-title">Tambah Data Manual</div>
                <input type="email" id="addEmail" placeholder="Email" style="margin-bottom: 12px;">
                <input type="text" id="addWa" placeholder="WhatsApp" style="margin-bottom: 12px;">
                <select id="addStatus" style="margin-bottom: 12px;">
                    <option value="New Acc">New Acc</option>
                    <option value="Old Acc">Old Acc</option>
                    <option value="Unrestric">Unrestric</option>
                    <option value="New Acc Restric">New Acc Restric</option>
                    <option value="Restric">Restric</option>
                    <option value="Bonus Only">Bonus Only</option>
                    <option value="Lost Payment">Lost Payment</option>
                </select>
                <input type="text" id="addReward" placeholder="Reward (Rp)" style="margin-bottom: 12px;">
                
                <hr style="border-color:rgba(0,0,0,0.05); margin:15px 0;">
                <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Kaitkan Rekening (Opsional):</div>
                
                <input type="text" id="addBank" placeholder="Nama Bank / E-Wallet" style="margin-bottom: 12px;">
                <input type="text" id="addName" placeholder="Atas Nama" style="margin-bottom: 12px;">
                <input type="number" id="addRek" placeholder="Nomor Rekening" style="margin-bottom: 12px;">

                <label style="margin-bottom: 6px;">Tanggal (Opsional):</label>
                <input type="date" id="addDate" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="addDataSingle()">Simpan Data</button>
            </div>

            <div class="glass-card admin-section">
                <div class="admin-title">Manajemen Data User</div>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="searchUserInput" placeholder="Cari Email..." onkeyup="filterManageList()" style="flex: 1; margin-bottom: 0;">
                    <select id="filterStatusInput" onchange="filterManageList()" style="flex: 1; margin-bottom: 0;">
                        <option value="ALL">Semua Status</option>
                        <option value="New Acc">New Acc</option>
                        <option value="Old Acc">Old Acc</option>
                        <option value="Unrestric">Unrestric</option>
                        <option value="New Acc Restric">New Acc Restric</option>
                        <option value="Restric">Restric</option>
                        <option value="Bonus Only">Bonus Only</option>
                        <option value="Lost Payment">Lost Payment</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button class="btn btn-primary btn-sm" onclick="loadManageData()" style="flex: 1;"><i class="fa-solid fa-rotate"></i> Muat Ulang</button>
                    <button class="btn btn-sm" onclick="exportToCSV()" style="flex: 1; background: var(--theme-green); color: white;"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
                </div>
                <div id="manageListCount" style="font-size: 0.8rem; color: var(--text-sec); margin-bottom: 12px; font-weight: 500; text-align: center;"></div>

                <div id="manageListContainer" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
                    <p style="text-align: center; color: var(--theme-gray);">Klik "Muat Ulang Data" untuk melihat list.</p>
                </div>
            </div>
        </div>

        <div id="feature-payment" class="admin-feature hidden">
            <div id="paymentMainView">
                <div class="glass-card">
                    <div class="admin-title">Statistik Penarikan</div>
                    <div class="stat-grid">
                        <div class="stat-box" style="background: rgba(255,149,0,0.15);">
                            <div class="stat-num" id="stat-pending" style="color: var(--theme-orange);">0</div>
                            <div class="stat-label" style="color: var(--theme-orange);">Menunggu</div>
                        </div>
                        <div class="stat-box" style="background: rgba(52,199,89,0.15);">
                            <div class="stat-num" id="stat-paid" style="color: var(--theme-green);">0</div>
                            <div class="stat-label" style="color: var(--theme-green);">Selesai</div>
                        </div>
                    </div>
                    <button class="btn btn-sewa" onclick="toggleHistoryView()" style="margin-bottom: 8px;">
                        <i class="fa-solid fa-clock-rotate-left"></i> Riwayat Transfer
                    </button>
                    
                    <button class="btn btn-sm" onclick="resetPaymentHistory()" style="width: 100%; margin-top: 4px; background: rgba(255, 59, 48, 0.15); color: var(--theme-red); border: 0.5px solid rgba(255, 59, 48, 0.3);">
                        <i class="fa-solid fa-trash-can"></i> Reset SEMUA (Pending/Done/Tolak)
                    </button>
                </div>

                <div style="margin-top: 20px; border-top: 0.5px solid var(--ios-glass-border); padding-top: 20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div class="admin-title" style="margin-bottom:0;">Mode Satu Payment</div>
                        <button class="btn btn-sm" onclick="toggleBulkView()" id="btnToggleBulk" style="width:auto; background:var(--theme-gray-light);">
                            <i class="fa-solid fa-list-check"></i> Buka List
                        </button>
                    </div>

                    <div id="bulkPaymentContainer" class="hidden slide-up-item">
                        <div class="glass-card">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <span style="font-size:0.8rem; color:var(--theme-gray);">Centang akun yang mau dibayar bareng:</span>
                                <span style="font-size:0.8rem; font-weight:bold; color:var(--theme-blue);">Total: Rp <span id="bulkTotal">0</span></span>
                            </div>

                            <div id="bulkList" class="scan-list-box" style="max-height: 300px;">
                                <p style="text-align:center; padding:20px;">Loading...</p>
                            </div>

                            <button class="btn btn-liquid-aurora" onclick="execBulkPayment()" style="margin-top:12px; font-size:0.9rem; padding:12px;">
                                <i class="fa-solid fa-check-double"></i> TRANSFER YANG DIPILIH
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card" style="background: transparent; border: none; padding: 0; box-shadow: none;">
                    <div class="admin-title" style="padding-left: 4px; display:flex; justify-content:space-between; align-items:center;">
                        <span>Antrian Transfer</span>
                        <button class="btn btn-primary btn-sm" onclick="loadPaymentTracking()" style="width:auto; background:var(--theme-gray-dark); color:var(--text-main);">
                            <i class="fa-solid fa-rotate"></i> Reload
                        </button>
                    </div>
                    
                    <div id="paymentFocusContainer" class="payment-focus-wrapper">
                        <p style="text-align:center; color:var(--theme-gray); margin-top:20px;">Memuat data...</p>
                    </div>
                </div>
            </div>

            <div id="paymentHistoryView" class="hidden slide-up-item">
                <div class="glass-card">
                    <div class="admin-title">Riwayat Transfer (Paid/Rejected)</div>
                    <button class="btn btn-sm btn-danger" onclick="toggleHistoryView()" style="width:auto; margin-bottom:15px;">
                        <i class="fa-solid fa-arrow-left"></i> Kembali ke Antrian
                    </button>
                    
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="historySearchInput" placeholder="Cari Email / Nama..." onkeyup="filterHistory()">
                    </div>

                    <div id="historyListContainer" class="scan-list-box" style="max-height: 500px;">
                        <p style="text-align:center; color:var(--theme-gray);">Memuat Riwayat...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="feature-mass" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Identifikasi & Proses Massal</div>
                <label>Paste List Email (1 email per baris):</label>
                <textarea id="massInput" rows="8" style="margin-bottom: 14px; font-size: 0.85rem;" placeholder="email1@gmail.com&#10;email2@gmail.com"></textarea>
                <button class="btn btn-primary" onclick="scanMassData()">
                    <i class="fa-solid fa-magnifying-glass"></i> SCAN / IDENTIFIKASI DATA
                </button>
                <div id="scanResultArea" style="display:none; margin-top: 20px; animation: fadeIn 0.5s;">
                    <div style="background:rgba(0,0,0,0.03); padding:10px; border-radius:12px; margin-bottom:16px;">
                        <div style="font-size:0.8rem; margin-bottom:8px; font-weight:600;">Setting untuk Proses:</div>
                        <select id="massStatus" style="margin-bottom: 8px;">
                            <option value="">-- Pilih Status Baru --</option>
                            <option value="New Acc">New Acc</option>
                            <option value="Old Acc">Old Acc</option>
                            <option value="Unrestric">Unrestric</option>
                            <option value="New Acc Restric">New Acc Restric</option>
                            <option value="Restric">Restric</option>
                            <option value="Bonus Only">Bonus Only</option>
                            <option value="Lost Payment">Lost Payment</option>
                        </select>
                        <input type="text" id="massReward" placeholder="Reward (Opsional)" style="margin-bottom: 8px;">
                        <input type="date" id="massDate">
                    </div>
                    <div style="margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-weight:600; font-size:0.9rem; color:var(--theme-green);">Terdeteksi di Database (<span id="countFound">0</span>)</span>
                        </div>
                        <div id="listFound" class="scan-list-box"></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-sewa" onclick="execMassUpdate()" style="font-size:0.8rem;">Update Data Terdeteksi</button>
                            <button class="btn btn-danger" onclick="execMassDelete()" style="font-size:0.8rem;">Hapus Data Terdeteksi</button>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-weight:600; font-size:0.9rem; color:var(--theme-blue);">Email Belum Terdaftar (<span id="countNew">0</span>)</span>
                        </div>
                        <div id="listNew" class="scan-list-box"></div>
                        <button class="btn btn-primary" onclick="execMassInsert()" style="font-size:0.8rem;">Simpan Data Baru</button>
                    </div>
                </div>
            </div>
            <div class="glass-card" style="margin-top: 20px;">
                <div class="admin-title">Kelola Berdasarkan Status (DB)</div>
                <div style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">Fitur ini bekerja pada semua data yang sudah ada di database.</div>
                <div style="padding-bottom:16px; margin-bottom:16px; border-bottom:0.5px solid var(--ios-glass-border);">
                    <label>Salin Semua Email:</label>
                    <div style="display:flex; gap:8px;">
                        <select id="copyStatusTarget" style="margin-bottom:0;">
                            <option value="ALL">Semua Status</option>
                            <option value="New Acc">New Acc</option>
                            <option value="Old Acc">Old Acc</option>
                            <option value="Unrestric">Unrestric</option>
                            <option value="New Acc Restric">New Acc Restric</option>
                            <option value="Restric">Restric</option>
                            <option value="Bonus Only">Bonus Only</option>
                            <option value="Lost Payment">Lost Payment</option>
                        </select>
                        <button class="btn btn-primary" style="width:auto; padding:0 20px;" onclick="copyEmailsByStatus()">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label>Update Reward Massal:</label>
                    <select id="rewardStatusTarget" style="margin-bottom:10px;">
                        <option value="">-- Pilih Target Status --</option>
                        <option value="New Acc">New Acc</option>
                        <option value="Old Acc">Old Acc</option>
                        <option value="Unrestric">Unrestric</option>
                        <option value="New Acc Restric">New Acc Restric</option>
                        <option value="Restric">Restric</option>
                        <option value="Bonus Only">Bonus Only</option>
                        <option value="Lost Payment">Lost Payment</option>
                    </select>
                    <input type="number" id="massRewardValue" placeholder="Nominal Baru (Misal: 50000)" style="margin-bottom:12px;">
                    <button class="btn btn-danger" onclick="updateRewardByStatus()">
                        Update Reward Massal
                    </button>
                </div>
            </div>
        </div>

        <div id="feature-bulletin" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Posting Buletin Baru</div>
                <label>Isi Pengumuman (Opsional jika kirim gambar):</label>
                <textarea id="bulletinInput" rows="4" style="margin-bottom: 12px;" placeholder="Tulis pengumuman di sini..."></textarea>
                
                <label>Upload Gambar (Opsional):</label>
                <input type="file" id="bulletinImage" accept="image/*" style="margin-bottom: 12px; background: rgba(10, 132, 255, 0.05); border: 1px dashed var(--theme-blue); border-radius: 12px; padding: 12px; width: 100%; color: var(--text-main); font-size: 0.85rem;">

                <button class="btn btn-primary" onclick="postBulletin()">
                    <i class="fa-solid fa-paper-plane"></i> Posting Sekarang
                </button>
            </div>
            <div class="glass-card admin-section">
                <div class="admin-title">Riwayat Pengumuman</div>
                <div id="adminBulletinList">
                    <p style="text-align:center; color:var(--theme-gray);">Loading...</p>
                </div>
            </div>
        </div>

        <div id="feature-stats" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Statistik User</div>
                <div class="stat-grid" id="statsContainer">
                    <div class="stat-box"><div class="stat-num">...</div><div class="stat-label">Loading</div></div>
                </div>
                <button class="btn btn-primary" onclick="loadStats()">Refresh Stats</button>
            </div>
        </div>

        <div id="feature-settings" class="admin-feature hidden">
            <div class="glass-card">
                <div class="admin-title">Pengaturan Global</div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: var(--theme-gray-dark); padding: 14px 16px; border-radius: 14px;">
                    <span style="font-weight: 500;">Withdraw User</span>
                    <button id="wdSwitchBtn" class="btn" style="width: auto; padding: 6px 16px; font-size: 0.85rem; border-radius: 20px;" onclick="toggleWithdrawSwitch()">
                        Loading...
                    </button>
                </div>
            </div>
        </div>

    </div>

</div>

<div id="allBulletinsModal" class="modal-overlay">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto; text-align: left;">
        <button class="close-modal-btn" onclick="closeAllBulletinsModal()">Ã—</button>
        <h3 style="color: var(--text-main); margin-top: 0; margin-bottom: 20px; font-weight: 700;">Semua Pengumuman</h3>
        <div id="allBulletinsContainer" class="all-bulletins-list">
            </div>
    </div>
</div>

<div id="imageModal" class="modal-overlay" onclick="closeImageModal()" style="z-index: 10005 !important;">
    <div class="modal-content" style="background: transparent !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important; box-shadow: none; border: none; padding: 0; max-width: 100%; display: flex; justify-content: center; align-items: center; height: 100%;">
         <button class="close-modal-btn" style="position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.8); z-index: 10006;">Ã—</button>
         <img id="fullSizeImageDisplay" src="" style="max-width: 95vw; max-height: 80vh; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); object-fit: contain;" onclick="event.stopPropagation()">
    </div>
</div>

<script>
    // 1. SUPABASE CONFIGURATION
    const supabaseUrl = 'https://bllzoxlrqzzfkcnyhyad.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsbHpveGxycXp6ZmtjbnloeWFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTk0NzgsImV4cCI6MjA4NjEzNTQ3OH0.I1BVt8lJJKYXWOX-xBiOwiq3D3-PEN7hEHYJw-VKe9c';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Global Vars
    let currentUserData = null;
    let isWithdrawOpen = false;
    let allUsersCache = [];
    
    // Vars untuk Payment Queue
    let paymentQueue = [];
    let initialQueueCount = 0;
    let completedQueueCount = 0;
    
    // Vars untuk Mass Scan
    let scannedFound = [];
    let scannedNew = [];

    // Vars untuk Fitur Pagination & Export
    let currentFilteredUsers = [];
    let currentDisplayLimit = 30;

    // FUNGSI ANIMASI UNTUK PERGANTIAN MENU TAB ADMIN
    function showFeature(featureName) {
        document.querySelectorAll('.admin-feature').forEach(el => {
            el.classList.add('hidden');
            el.classList.remove('fade-in'); 
        });
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        
        const targetFeature = document.getElementById('feature-' + featureName);
        targetFeature.classList.remove('hidden');
        
        void targetFeature.offsetWidth;
        targetFeature.classList.add('fade-in');

        const btnMap = { 'home':0, 'payment':1, 'mass':2, 'bulletin':3, 'stats':4, 'settings':5 };
        const buttons = document.querySelectorAll('.nav-btn');
        if(buttons[btnMap[featureName]]) buttons[btnMap[featureName]].classList.add('active');
        
        if(featureName === 'home') loadManageData();
        if(featureName === 'payment') { loadPaymentTracking(); loadPaymentStats(); }
        if(featureName === 'stats') loadStats();
        if(featureName === 'bulletin') loadAdminBulletin();
        if(featureName === 'settings') getWithdrawStatus();
    }

    // ==========================================
    // OPTIMASI ANIMASI TRANSISI (FLIP Technique)
    // ==========================================
    function enterApp() {
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const welcomeImg = document.getElementById('welcomeImg'); // Circle Image
        const welcomeContent = document.getElementById('welcomeContent'); 
        const app = document.querySelector('.app-container');
        const audio = document.getElementById('bgMusic');
        const targetBanner = document.querySelector('.banner-img');

        // Play Music
        audio.volume = 0.5; 
        audio.play().catch(e => console.log("Audio play blocked:", e));

        loadBulletin(); // Panggil fungsi Papan Buletin untuk load awal

        // 1. Fade out content text & button
        welcomeContent.style.opacity = '0';
        welcomeContent.style.transition = 'opacity 0.3s';

        // 2. Prepare App View (Hidden but layout calculated)
        app.style.display = 'block';
        app.style.opacity = '0';

        // 3. FLIP TECHNIQUE: Calculate Positions
        // First: Posisi awal gambar welcome
        const startRect = welcomeImg.getBoundingClientRect();
        // Last: Posisi akhir banner di dalam app
        const endRect = targetBanner.getBoundingClientRect();

        // 4. Set Initial Fixed Position (Lock in place)
        // Kita ubah posisi gambar welcome menjadi fixed di koordinat awal agar tidak lompat
        welcomeImg.style.position = 'fixed';
        welcomeImg.style.top = startRect.top + 'px';
        welcomeImg.style.left = startRect.left + 'px';
        welcomeImg.style.width = startRect.width + 'px';
        welcomeImg.style.height = startRect.height + 'px';
        welcomeImg.style.margin = '0'; // Reset margin bawaan
        welcomeImg.style.transform = 'none'; // Reset transform jika ada
        welcomeImg.style.zIndex = '10001'; // Pastikan di atas segalanya

        // Force Reflow (Browser perlu baca posisi baru sebelum animasi jalan)
        void welcomeImg.offsetHeight;

        // 5. Animate to Target Position
        // Gunakan cubic-bezier yang smooth (curve pelan di awal & akhir)
        welcomeImg.style.transition = 'all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)'; 
        
        // Pindahkan ke koordinat akhir banner
        welcomeImg.style.top = endRect.top + 'px';
        welcomeImg.style.left = endRect.left + 'px';
        welcomeImg.style.width = endRect.width + 'px';
        welcomeImg.style.height = endRect.height + 'px';
        welcomeImg.style.borderRadius = '16px'; // Ubah radius jadi kotak rounded
        welcomeImg.style.border = '0.5px solid rgba(0, 0, 0, 0.08)';
        welcomeImg.style.boxShadow = 'none';

        // 6. Cleanup after animation
        setTimeout(() => {
            app.style.opacity = '1';
            app.classList.add('fade-in');
            
            // Hide Overlay Background
            welcomeOverlay.style.background = 'transparent';
            
            // Final cleanup
            setTimeout(() => {
                welcomeOverlay.style.display = 'none';
            }, 800);
        }, 300); // Delay sedikit biar mata menangkap pergerakan awal
    }

    function closeModal() {
        const modal = document.getElementById('statusModal');
        modal.classList.remove('active');
    }

    // [NEW] FUNGSI MODAL GAMBAR FULL SIZE
    function openImageModal(imageUrl) {
        const modal = document.getElementById('imageModal');
        const fullImage = document.getElementById('fullSizeImageDisplay');
        fullImage.src = imageUrl;
        modal.classList.add('active');
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.remove('active');
        setTimeout(() => {
             document.getElementById('fullSizeImageDisplay').src = '';
        }, 300); // Clear src after animation finishes
    }

    function getStatusColor(status) {
        if (!status) return { bg: 'rgba(0,0,0,0.05)', color: '#000', shadow: 'transparent', icon: '<i class="fa-solid fa-user"></i>' };
        
        const s = status.toLowerCase();
        
        if (s === 'new acc' || s === 'old acc') {
            return { bg: 'rgba(10, 132, 255, 0.1)', color: '#0A84FF', shadow: 'transparent', icon: '<i class="fa-solid fa-sack-dollar"></i>' }; 
        }
        else if (s === 'unrestrict' || s === 'unrestric') { 
            return { bg: 'rgba(0, 0, 0, 0.05)', color: '#333333', shadow: 'transparent', icon: '<i class="fa-solid fa-check"></i>' }; 
        }
        else if (s === 'new acc restric' || s === 'restric new acc') { 
            return { bg: 'rgba(255, 149, 0, 0.1)', color: '#FF9500', shadow: 'transparent', icon: '<i class="fa-solid fa-triangle-exclamation"></i>' }; 
        }
        else if (s.includes('restric') || s === 'bonus only') {
            return { bg: 'rgba(255, 59, 48, 0.1)', color: '#FF3B30', shadow: 'transparent', icon: '<i class="fa-solid fa-triangle-exclamation"></i>' }; 
        }
        else {
            return { bg: 'rgba(0, 0, 0, 0.05)', color: '#333333', shadow: 'transparent', icon: '<i class="fa-solid fa-user"></i>' };
        }
    }

    async function checkStatus() {
        const emailInput = document.getElementById('userEmail').value.trim();
        if (!emailInput) return Swal.fire({title:'Error', text:'Masukkan email terlebih dahulu', icon:'error', background:'#ffffff', color:'#000'});

        Swal.fire({ title: 'Mengecek...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
        await getWithdrawStatus();
        const { data, error } = await _supabase.from('linked_users').select('*').ilike('email', emailInput).single();
        Swal.close();

        if (error || !data) {
            Swal.fire({icon: 'error', title: 'Tidak Ditemukan', text: 'Email tidak terdaftar.', background: '#ffffff', color: '#000'});
            return;
        }
        currentUserData = data;
        renderUserResult(data);
    }

    function renderUserResult(data) {
        const modal = document.getElementById('statusModal');
        const badge = document.getElementById('statusBadge');
        const avatar = document.getElementById('statusAvatar');
        
        document.getElementById('resEmail').innerText = data.email;
        // Kartu Saldo (Saran 2)
        document.getElementById('resReward').innerText = data.reward ? `Rp ${data.reward.toLocaleString('id-ID')}` : 'Rp 0';

        badge.innerText = data.status || 'UNKNOWN';
        const style = getStatusColor(data.status);
        badge.style.background = style.bg;
        badge.style.color = style.color;
        badge.style.border = `1px solid ${style.color}50`;
        badge.style.boxShadow = `0 0 15px ${style.color}20`; 
        avatar.innerHTML = style.icon; // Set icon avatar dinamis

        const wdSec = document.getElementById('withdrawSection');
        const ptSec = document.getElementById('progressTrackerSection');
        const bankGroup = document.getElementById('lockedBankGroup');
        const overlay = document.getElementById('lockedOverlay');
        const inputName = document.getElementById('wdName');
        const inputBank = document.getElementById('wdBank');
        const inputRek = document.getElementById('wdRek');
        const inputWA = document.getElementById('wdWA');
        
        // Reset state input form
        [inputName, inputBank, inputRek, inputWA].forEach(el => {
            el.value = '';
            el.readOnly = false;
            el.style.background = 'var(--theme-gray-dark)';
            el.style.border = '0.5px solid transparent';
            el.style.color = 'var(--text-main)';
            el.style.cursor = 'text';
        });
        bankGroup.classList.remove('locked-mode');
        overlay.style.display = 'none';

        // Cek Progress Tracker jika sudah diklaim (Saran 3)
        if (data.payment_status === 'claimed' || data.payment_status === 'paid' || data.payment_status === 'rejected') {
            wdSec.classList.add('hidden');
            ptSec.classList.remove('hidden');
            
            const ptLine = document.getElementById('ptLineFill');
            const step1 = document.getElementById('ptStep1');
            const step2 = document.getElementById('ptStep2');
            const step3 = document.getElementById('ptStep3');
            
            // Reset tracker visual state
            [step1, step2, step3].forEach(el => el.className = 'pt-step');
            
            if (data.payment_status === 'claimed') {
                ptLine.style.width = '50%';
                step1.classList.add('done');
                step2.classList.add('active');
                step3.querySelector('.pt-icon').innerHTML = '<i class="fa-solid fa-check-double"></i>';
                step3.querySelector('.pt-label').innerText = 'Selesai';
            } else if (data.payment_status === 'paid') {
                ptLine.style.width = '100%';
                step1.classList.add('done');
                step2.classList.add('done');
                step3.classList.add('done');
                step3.querySelector('.pt-icon').innerHTML = '<i class="fa-solid fa-check-double"></i>';
                step3.querySelector('.pt-label').innerText = 'Selesai';
            } else if (data.payment_status === 'rejected') {
                ptLine.style.width = '100%';
                step1.classList.add('done');
                step2.classList.add('done');
                step3.classList.add('rejected');
                step3.querySelector('.pt-icon').innerHTML = '<i class="fa-solid fa-xmark"></i>';
                step3.querySelector('.pt-label').innerText = 'Ditolak';
            }
        } else {
            // Jika belum di-klaim
            ptSec.classList.add('hidden');
            
            // Saran 4: Pertegas Visual Data Terkunci (jika form dibuka Admin)
            if (isWithdrawOpen) {
                wdSec.classList.remove('hidden');
                
                if (data.acc_number && String(data.acc_number).length > 2) {
                    inputName.value = data.acc_name || '';
                    inputBank.value = data.bank_name || '';
                    inputRek.value = data.acc_number || '';
                    inputWA.value = data.whatsapp || '';

                    // Mode Gembok/Terkunci Aktif
                    bankGroup.classList.add('locked-mode');
                    overlay.style.display = 'flex';
                    
                    // Kolom Rekening Bank dibuat tidak bisa diklik via CSS parent,
                    // Tapi WA tetap dicek secara terpisah.
                    if (data.whatsapp && String(data.whatsapp).length > 5) {
                        inputWA.readOnly = true;
                        inputWA.style.background = 'rgba(52, 199, 89, 0.05)';
                        inputWA.style.border = '1px dashed rgba(52, 199, 89, 0.5)';
                        inputWA.style.cursor = 'not-allowed';
                    } else {
                        inputWA.readOnly = false;
                        inputWA.style.background = 'var(--theme-gray-dark)';
                        inputWA.style.border = '1px solid var(--theme-green)';
                        inputWA.style.cursor = 'text';
                    }
                }
            } else {
                wdSec.classList.add('hidden');
            }
        }

        modal.classList.add('active'); 
    }

    async function submitWithdraw() {
        const name = document.getElementById('wdName').value;
        const bank = document.getElementById('wdBank').value;
        const rek = document.getElementById('wdRek').value;
        const wa = document.getElementById('wdWA').value;

        if(!name || !bank || !rek || !wa) return Swal.fire({title: 'Gagal', text:'Lengkapi semua kolom termasuk WhatsApp.', icon:'warning', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
        
        // Logic tambahan: Validasi format WA
        if (!wa.toString().startsWith('08')) {
            return Swal.fire({title: 'Format Salah', text:'Nomor WhatsApp harus berawalan 08.', icon:'warning', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
        }

        Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });

        const { error } = await _supabase.from('linked_users').update({
            payment_status: 'claimed', acc_name: name, bank_name: bank, acc_number: rek, whatsapp: wa, withdraw_date: new Date().toISOString()
        }).eq('id', currentUserData.id);

        if (error) Swal.fire({title: 'Error', text: error.message, icon:'error', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
        else {
            Swal.fire({icon: 'success', title: 'Berhasil!', text: 'Permintaan penarikan terkirim.', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
            
            // Render ulang modal langsung untuk pindah ke tampilan Progress Tracker
            currentUserData.payment_status = 'claimed';
            renderUserResult(currentUserData);
        }
    }

    async function getWithdrawStatus() {
        const { data } = await _supabase.from('app_settings').select('is_active').eq('setting_name', 'withdraw_feature').single();
        if (data) isWithdrawOpen = data.is_active; else isWithdrawOpen = true;
        updateAdminSwitchUI();
    }

    // ==========================================
    // LOGIC POLA (PATTERN LOCK)
    // ==========================================
    let isDrawing = false;
    let patternPath = [];
    const patternGrid = document.getElementById('patternGrid');
    const patternSvg = document.getElementById('patternSvg');

    // 1. GENERATE DOTS
    function initPatternLock() {
        patternGrid.innerHTML = '<svg id="patternSvg"></svg>'; // Reset
        for(let i=1; i<=9; i++) {
            const dot = document.createElement('div');
            dot.className = 'p-dot';
            dot.dataset.id = i;
            dot.innerHTML = '<div class="p-dot-inner"></div>';
            patternGrid.appendChild(dot);
        }
        
        // Re-get reference after innerHTML reset
        const svg = document.getElementById('patternSvg');
        
        // Events
        patternGrid.addEventListener('mousedown', startPattern);
        patternGrid.addEventListener('touchstart', startPattern, {passive: false});
        
        window.addEventListener('mouseup', endPattern);
        window.addEventListener('touchend', endPattern);
        
        window.addEventListener('mousemove', movePattern);
        window.addEventListener('touchmove', movePattern, {passive: false});
    }

    function getEventPos(e) {
        if(e.touches) {
            return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        } else {
            return { x: e.clientX, y: e.clientY };
        }
    }

    function startPattern(e) {
        e.preventDefault();
        isDrawing = true;
        patternPath = [];
        clearPattern();
        checkCollision(getEventPos(e));
    }

    function movePattern(e) {
        if(!isDrawing) return;
        e.preventDefault();
        const pos = getEventPos(e);
        checkCollision(pos);
        drawCurrentLine(pos);
    }

    function endPattern(e) {
        if(!isDrawing) return;
        isDrawing = false;
        validatePattern();
    }

    function checkCollision(pos) {
        const dots = document.querySelectorAll('.p-dot');
        const gridRect = patternGrid.getBoundingClientRect();
        
        dots.forEach(dot => {
            const rect = dot.getBoundingClientRect();
            // Center point of dot
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            
            // Distance check (radius ~20px)
            const dist = Math.hypot(pos.x - centerX, pos.y - centerY);
            
            if(dist < 30) {
                const id = dot.dataset.id;
                if(!patternPath.includes(id)) {
                    patternPath.push(id);
                    dot.classList.add('active');
                    updateLines();
                    
                    // Haptic feedback if supported
                    if(navigator.vibrate) navigator.vibrate(20);
                }
            }
        });
    }

    function updateLines() {
        const svg = document.getElementById('patternSvg');
        // Clear existing static lines
        const oldLines = svg.querySelectorAll('.p-line-static');
        oldLines.forEach(l => l.remove());

        if(patternPath.length > 1) {
            for(let i=0; i<patternPath.length-1; i++) {
                const dot1 = document.querySelector(`.p-dot[data-id="${patternPath[i]}"]`);
                const dot2 = document.querySelector(`.p-dot[data-id="${patternPath[i+1]}"]`);
                drawLine(dot1, dot2, svg);
            }
        }
    }

    function drawLine(dot1, dot2, svg) {
        const rect1 = dot1.getBoundingClientRect();
        const rect2 = dot2.getBoundingClientRect();
        const gridRect = patternGrid.getBoundingClientRect();

        const x1 = rect1.left + rect1.width/2 - gridRect.left;
        const y1 = rect1.top + rect1.height/2 - gridRect.top;
        const x2 = rect2.left + rect2.width/2 - gridRect.left;
        const y2 = rect2.top + rect2.height/2 - gridRect.top;

        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1); line.setAttribute("y1", y1);
        line.setAttribute("x2", x2); line.setAttribute("y2", y2);
        line.classList.add('p-line', 'p-line-static');
        svg.appendChild(line);
    }

    function drawCurrentLine(pos) {
        const svg = document.getElementById('patternSvg');
        const currentLine = document.getElementById('p-line-dynamic');
        
        if(patternPath.length === 0) return;

        const lastDotId = patternPath[patternPath.length-1];
        const lastDot = document.querySelector(`.p-dot[data-id="${lastDotId}"]`);
        const rect = lastDot.getBoundingClientRect();
        const gridRect = patternGrid.getBoundingClientRect();

        const x1 = rect.left + rect.width/2 - gridRect.left;
        const y1 = rect.top + rect.height/2 - gridRect.top;
        const x2 = pos.x - gridRect.left;
        const y2 = pos.y - gridRect.top;

        if(!currentLine) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.id = 'p-line-dynamic';
            line.classList.add('p-line');
            svg.appendChild(line);
        } else {
            currentLine.setAttribute("x1", x1);
            currentLine.setAttribute("y1", y1);
            currentLine.setAttribute("x2", x2);
            currentLine.setAttribute("y2", y2);
        }
    }

    function clearPattern() {
        document.querySelectorAll('.p-dot').forEach(d => d.classList.remove('active'));
        document.getElementById('patternSvg').innerHTML = ''; // Clear lines
    }

    function validatePattern() {
        // Hapus garis dynamic
        const dLine = document.getElementById('p-line-dynamic');
        if(dLine) dLine.remove();

        const inputCode = patternPath.join('');
        
        // --- OBFUSCATED CHECK ---
        // Target: 4569871
        // Split: 456, 98, 71
        const _s1 = "NDU2"; 
        const _s2 = "OTg=";
        const _s3 = "NzE=";
        const _target = atob(_s1) + atob(_s2) + atob(_s3);

        if(inputCode === _target) {
            // Success
            closeAdminLogin();
            document.getElementById('userView').classList.add('hidden');
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminPanel').classList.add('fade-in');
            showFeature('home'); getWithdrawStatus();
        } else {
            // Fail
            const dots = document.querySelectorAll('.p-dot.active');
            dots.forEach(d => d.style.background = 'rgba(255,59,48,0.3)');
            setTimeout(() => {
                dots.forEach(d => d.style.background = '');
                clearPattern();
            }, 500);
            
            if(inputCode.length > 2) { // Feedback only if meaningful attempt
                const Toast = Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1500, background: '#FF3B30', color: '#fff'});
                Toast.fire({icon: 'error', title: 'Pola Salah'});
            }
        }
    }

    // --- UI CONTROLLERS ---
    function openAdminPattern() {
        document.getElementById('adminLoginOverlay').style.display = 'flex';
        initPatternLock(); // Init grid logic
    }

    function closeAdminLogin() {
        document.getElementById('adminLoginOverlay').style.display = 'none';
        clearPattern();
        isDrawing = false;
    }

    // --- EXISTING ADMIN FUNCTIONS ---
    function logoutAdmin() {
        document.getElementById('adminPanel').style.display = 'none';
        const uView = document.getElementById('userView');
        uView.classList.remove('hidden');
        void uView.offsetWidth;
        uView.classList.add('fade-in');
    }

    async function loadStats() {
        const { data, error } = await _supabase.from('linked_users').select('status');
        if(error) return;

        const counts = {};
        
        data.forEach(row => { 
            let s = row.status || 'Unknown';
            s = s.trim(); 
            const lower = s.toLowerCase();

            if (lower === 'new acc') s = 'New Acc';
            else if (lower === 'old acc') s = 'Old Acc';
            else if (lower === 'new acc restric') s = 'New Acc Restric';
            else if (lower === 'restric' || lower === 'restrict') s = 'Restric';
            else if (lower === 'unrestric' || lower === 'unrestrict') s = 'Unrestric';
            else if (lower === 'bonus only') s = 'Bonus Only';
            else if (lower === 'lost payment') s = 'Lost Payment';

            counts[s] = (counts[s] || 0) + 1; 
        });

        const container = document.getElementById('statsContainer');
        container.innerHTML = `<div class="stat-box slide-up-item" style="grid-column: span 2; background: rgba(10, 132, 255, 0.1); animation-delay: 0s;"><div class="stat-num">${data.length}</div><div class="stat-label" style="color:var(--text-sec);">TOTAL DATA</div></div>`;
        
        const sortedEntries = Object.entries(counts).sort((a, b) => b[1] - a[1]);

        let delayIndex = 1;
        for (const [key, val] of sortedEntries) { 
            const animDelay = (delayIndex * 0.05).toFixed(2); 
            let colorStyle = 'var(--text-sec)';
            if(key.includes('Restric')) colorStyle = 'var(--theme-orange)';
            if(key === 'New Acc' || key === 'Old Acc') colorStyle = 'var(--theme-blue)';

            container.innerHTML += `
            <div class="stat-box slide-up-item" style="animation-delay: ${animDelay}s">
                <div class="stat-num">${val}</div>
                <div class="stat-label" style="color:${colorStyle};">${key}</div>
            </div>`; 
            delayIndex++;
        }
    }

    function updateAdminSwitchUI() {
        const btn = document.getElementById('wdSwitchBtn');
        if(isWithdrawOpen) { btn.innerText = 'Buka'; btn.style.background = 'var(--theme-green)'; btn.style.color = '#fff'; } 
        else { btn.innerText = 'Tutup'; btn.style.background = 'var(--theme-gray-light)'; btn.style.color = '#fff'; }
    }

    async function toggleWithdrawSwitch() {
        const newState = !isWithdrawOpen;
        const { error } = await _supabase.from('app_settings').update({ is_active: newState }).eq('setting_name', 'withdraw_feature');
        if(!error) { isWithdrawOpen = newState; updateAdminSwitchUI(); Swal.fire({title:'Sukses', text: newState ? 'Form Dibuka' : 'Form Ditutup', icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'}); }
    }

    // === FITUR BARU: LOAD MANAGE DATA (DENGAN PAGINATION & INDIKATOR) ===
    async function loadManageData() {
        const list = document.getElementById('manageListContainer'); 
        list.innerHTML = '<p style="text-align:center; color: var(--theme-gray);">Loading...</p>';
        document.getElementById('manageListCount').innerText = 'Memuat data...';

        const { data, error } = await _supabase.from('linked_users').select('*').order('created_at', { ascending: false }).limit(500);
        
        if (error) { 
            list.innerHTML = '<p style="text-align:center; color: var(--theme-red);">Gagal memuat data.</p>'; 
            document.getElementById('manageListCount').innerText = '';
            return; 
        }
        
        allUsersCache = data; 
        filterManageList(); // Panggil filter untuk mengatur render awal
    }

    // === FITUR BARU: FILTER DAN PAGINATION STATE ===
    function filterManageList() {
        const q = document.getElementById('searchUserInput').value.toLowerCase();
        const statusFilter = document.getElementById('filterStatusInput').value;

        currentFilteredUsers = allUsersCache.filter(u => {
            const matchesSearch = (u.email && u.email.toLowerCase().includes(q)) || (u.status && u.status.toLowerCase().includes(q));
            const sRaw = u.status || '';
            const sDb = sRaw.toLowerCase().trim(); 
            const sFilter = statusFilter.toLowerCase().trim(); 
            const matchesStatus = statusFilter === 'ALL' || sDb === sFilter;
            return matchesSearch && matchesStatus;
        });

        currentDisplayLimit = 30; // Reset limit saat filter berubah
        renderManageList();
    }

    // === FITUR BARU: RENDER DENGAN PAGINATION (LOAD MORE) ===
    function renderManageList() {
        const list = document.getElementById('manageListContainer');
        const countIndicator = document.getElementById('manageListCount');

        if (currentFilteredUsers.length === 0) { 
            list.innerHTML = '<p style="text-align:center; color:var(--theme-gray);">Kosong.</p>'; 
            countIndicator.innerText = '0 data ditemukan';
            return; 
        }
        
        // Sorting: Data yang bukan Restric tampil lebih dulu
        const nonRestricData = currentFilteredUsers.filter(item => !(item.status || '').toLowerCase().includes('restric'));
        const restricData = currentFilteredUsers.filter(item => (item.status || '').toLowerCase().includes('restric'));
        const sortedData = [...nonRestricData, ...restricData];

        // Potong array berdasarkan limit display (Pagination)
        const dataToRender = sortedData.slice(0, currentDisplayLimit);
        
        // Update Indikator Jumlah Data (Fitur 3)
        countIndicator.innerText = `Menampilkan ${dataToRender.length} dari total ${currentFilteredUsers.length} data ditemukan.`;

        let html = '';
        dataToRender.forEach((item, index) => {
            const style = getStatusColor(item.status);
            // Matikan delay animasi agar load more terasa lebih cepat (opsional)
            const animDelay = (index < 20) ? (index * 0.02).toFixed(2) : 0; 
            
            html += `<div class="user-manage-card slide-up-item" style="animation-delay: ${animDelay}s">
                        <div class="um-header">
                            <div class="um-email" style="display:flex; align-items:center;">
                                ${item.email}
                                <i class="fa-regular fa-copy" onclick="copyText('${item.email}')" style="cursor:pointer; margin-left:8px; color:var(--theme-blue);"></i>
                            </div>
                            <div style="font-size:0.7rem; font-weight:600; background: ${style.bg}; padding:4px 10px; border-radius:12px; border:1px solid ${style.color}50; color: ${style.color} !important;">${item.status}</div>
                        </div>
                        <div class="um-meta"><i class="fa-brands fa-whatsapp"></i> ${item.whatsapp || '-'} | Rp ${item.reward || 0}</div>
                        <div class="um-meta" style="font-size:0.75rem; color:var(--theme-gray);">Date: ${new Date(item.created_at).toLocaleDateString()}</div>
                        <div class="um-actions">
                            <button class="btn btn-sm" style="background: var(--theme-blue); color:white;" onclick="editUser(${item.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${item.id})">Hapus</button>
                        </div>
                     </div>`;
        });

        // Fitur 2: Tombol Load More
        if (currentFilteredUsers.length > currentDisplayLimit) {
            const sisa = currentFilteredUsers.length - currentDisplayLimit;
            html += `<button class="btn btn-sm" onclick="loadMoreManageData()" style="width:100%; background:var(--theme-gray-light); color:var(--text-main); margin-top:16px; margin-bottom:10px;">Load More (${sisa} data tersisa)</button>`;
        }

        list.innerHTML = html;
    }

    // === FITUR BARU: TOMBOL LOAD MORE ACTION ===
    function loadMoreManageData() {
        currentDisplayLimit += 30; // Tambah 30 data per klik
        renderManageList();
    }

    // === FITUR BARU: EXPORT DATA KE CSV (MODIFIED) ===
    function exportToCSV() {
        if (!currentFilteredUsers || currentFilteredUsers.length === 0) {
            Swal.fire({title: 'Kosong', text: 'Tidak ada data untuk diekspor.', icon: 'warning', background: '#ffffff', color: '#000'});
            return;
        }

        // Filter data: Ambil semua KECUALI yang statusnya sama persis dengan "Restric" (huruf besar/kecil tidak ngaruh)
        const dataToExport = currentFilteredUsers.filter(u => {
            if (!u.status) return true; // kalau status kosong, biarkan masuk
            return u.status.toLowerCase().trim() !== 'restric'; // "New Acc Restric" akan lolos karena tidak sama dengan "restric"
        });

        if (dataToExport.length === 0) {
            Swal.fire({title: 'Kosong', text: 'Tidak ada data valid untuk diekspor (semua berstatus Restric).', icon: 'warning', background: '#ffffff', color: '#000'});
            return;
        }

        // Header File Excel/CSV HANYA untuk Email dan Status
        const headers = ["Email", "Status"];
        let csvRows = [headers.join(",")];

        // Looping data yang sudah difilter
        dataToExport.forEach(u => {
            const row = [
                `"${u.email || ''}"`,
                `"${u.status || ''}"`
            ];
            csvRows.push(row.join(","));
        });

        const csvString = csvRows.join("\n");
        const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", `Data_Email_Status_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function deleteUser(id) {
        const res = await Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#FF3B30', cancelButtonColor: '#d1d1d6', confirmButtonText: 'Hapus', background: '#ffffff', color: '#000' });
        if (res.isConfirmed) { await _supabase.from('linked_users').delete().eq('id', id); loadManageData(); loadStats(); }
    }

    // --- MODIFIED EDIT USER FUNCTION (FULL DATA EDIT) ---
    async function editUser(id) {
        const u = allUsersCache.find(x => x.id === id); if(!u) return;
        
        const { value: v } = await Swal.fire({
            title: 'Edit Data User',
            background: '#ffffff',
            color: '#000',
            confirmButtonColor: '#0A84FF',
            cancelButtonColor: '#d1d1d6',
            showCancelButton: true,
            confirmButtonText: 'Simpan Perubahan',
            html: `
            <div style="text-align:left; margin-bottom:10px;">
                <label class="swal-label">Status</label>
                <select id="swal-s" class="swal-dark-input">
                    <option value="New Acc" ${u.status=='New Acc'?'selected':''}>New Acc</option>
                    <option value="Old Acc" ${u.status=='Old Acc'?'selected':''}>Old Acc</option>
                    <option value="Unrestric" ${u.status=='Unrestric'?'selected':''}>Unrestric</option>
                    <option value="New Acc Restric" ${u.status=='New Acc Restric'?'selected':''}>New Acc Restric</option>
                    <option value="Restric" ${u.status=='Restric'?'selected':''}>Restric</option>
                    <option value="Bonus Only" ${u.status=='Bonus Only'?'selected':''}>Bonus Only</option>
                    <option value="Lost Payment" ${u.status=='Lost Payment'?'selected':''}>Lost Payment</option>
                </select>
                <label class="swal-label">Reward (Rp)</label>
                <input id="swal-r" class="swal-dark-input" value="${u.reward||''}">
                
                <hr style="border-color:rgba(0,0,0,0.05); margin:15px 0;">
                <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Kaitkan/Edit Data Rekening:</div>

                <label class="swal-label">Nama Bank</label>
                <input id="swal-bank" class="swal-dark-input" value="${u.bank_name||''}" placeholder="Contoh: BCA / DANA">
                
                <label class="swal-label">Atas Nama</label>
                <input id="swal-name" class="swal-dark-input" value="${u.acc_name||''}" placeholder="Nama Pemilik">
                
                <label class="swal-label">Nomor Rekening</label>
                <input id="swal-rek" class="swal-dark-input" value="${u.acc_number||''}" placeholder="1234567890">
                
                <label class="swal-label">WhatsApp</label>
                <input id="swal-w" class="swal-dark-input" value="${u.whatsapp||''}">
            </div>`,
            preConfirm: () => ({
                status: document.getElementById('swal-s').value,
                reward: document.getElementById('swal-r').value,
                bank_name: document.getElementById('swal-bank').value,
                acc_name: document.getElementById('swal-name').value,
                acc_number: document.getElementById('swal-rek').value,
                whatsapp: document.getElementById('swal-w').value
            })
        });

        if (v) {
            Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
            
            const { error } = await _supabase.from('linked_users').update(v).eq('id', id);
            
            if(!error) {
                Swal.fire({title:'Sukses', text:'Data berhasil diperbarui.', icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
                loadManageData();
                loadStats();
            } else {
                Swal.fire({title:'Gagal', text:error.message, icon:'error', background: '#ffffff', color: '#000'});
            }
        }
    }

    async function addDataSingle() {
        const e = document.getElementById('addEmail').value.trim(), w = document.getElementById('addWa').value, s = document.getElementById('addStatus').value, r = document.getElementById('addReward').value, d = document.getElementById('addDate').value;
        const bank = document.getElementById('addBank').value;
        const name = document.getElementById('addName').value;
        const rek = document.getElementById('addRek').value;

        if(!e) return Swal.fire({title:'Error', text:'Email wajib.', icon:'warning', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
        const { data: ex } = await _supabase.from('linked_users').select('id').eq('email', e).single();
        if(ex) return Swal.fire({title:'Gagal', text:'Email sudah ada.', icon:'error', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
        
        const p = { email: e, whatsapp: w, status: s, reward: r, bank_name: bank, acc_name: name, acc_number: rek }; 
        if(d) p.created_at = new Date(d).toISOString();
        
        const { error } = await _supabase.from('linked_users').insert([p]);
        if(!error) { 
            Swal.fire({title:'Sukses', text:'Data tersimpan.', icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'}); 
            document.getElementById('addEmail').value = ''; 
            loadManageData(); loadStats(); 
        }
    }

    // === FITUR MASS SCAN ===
    
    async function scanMassData() {
        const raw = document.getElementById('massInput').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const list = raw.split('\n').map(x => x.trim()).filter(x => x !== '' && emailRegex.test(x)); 
        
        if(list.length === 0) return Swal.fire({title:'Kosong/Invalid', text:'Tidak ada email valid yang ditemukan.', icon:'warning', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
        
        Swal.fire({ title: 'Scanning...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });

        scannedFound = []; scannedNew = [];

        const { data: existingUsers, error } = await _supabase.from('linked_users').select('email, status, reward').in('email', list);
        
        if (error) {
            Swal.fire({title:'Error', text: error.message, icon:'error', background: '#ffffff', color: '#000'});
            return;
        }

        const foundEmails = existingUsers.map(u => u.email.toLowerCase());
        scannedFound = existingUsers; 
        scannedNew = list.filter(e => !foundEmails.includes(e.toLowerCase()));

        document.getElementById('scanResultArea').style.display = 'block';
        document.getElementById('countFound').innerText = scannedFound.length;
        document.getElementById('countNew').innerText = scannedNew.length;

        const listFoundEl = document.getElementById('listFound');
        listFoundEl.innerHTML = scannedFound.length ? '' : '<div style="padding:10px; text-align:center; color:#555;">Tidak ada data ditemukan</div>';
        scannedFound.forEach(u => {
            listFoundEl.innerHTML += `<div class="scan-item"><input type="checkbox" class="chk-found" value="${u.email}" checked><span>${u.email}</span><span class="tag-found">${u.status} | ${u.reward}</span></div>`;
        });

        const listNewEl = document.getElementById('listNew');
        listNewEl.innerHTML = scannedNew.length ? '' : '<div style="padding:10px; text-align:center; color:#555;">Tidak ada email baru</div>';
        scannedNew.forEach(email => {
            listNewEl.innerHTML += `<div class="scan-item"><input type="checkbox" class="chk-new" value="${email}" checked><span>${email}</span><span class="tag-new">New</span></div>`;
        });

        Swal.close();
    }

    async function execMassUpdate() {
        const checkboxes = document.querySelectorAll('.chk-found:checked');
        const emailsToUpdate = Array.from(checkboxes).map(cb => cb.value);

        if (emailsToUpdate.length === 0) return Swal.fire({title:'Kosong', text:'Pilih data yang ingin diupdate.', icon:'warning', background: '#ffffff', color: '#000'});

        const s = document.getElementById('massStatus').value;
        const r = document.getElementById('massReward').value;
        
        if (!s && !r) return Swal.fire({title:'Info', text:'Pilih Status atau Reward baru.', icon:'info', background: '#ffffff', color: '#000'});

        const confirm = await Swal.fire({
            title: 'Update Massal?',
            text: `Akan mengupdate ${emailsToUpdate.length} data terpilih.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Update',
            confirmButtonColor: '#0A84FF',
            background: '#ffffff', color: '#000'
        });

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Updating...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
            
            const updates = {};
            if(s) updates.status = s;
            if(r) updates.reward = r;

            const { error } = await _supabase.from('linked_users').update(updates).in('email', emailsToUpdate);

            if (!error) {
                Swal.fire({title:'Sukses', text:'Data berhasil diupdate.', icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
                loadManageData(); loadStats(); scanMassData(); 
            } else {
                Swal.fire({title:'Gagal', text:error.message, icon:'error', background: '#ffffff', color: '#000'});
            }
        }
    }

    async function execMassDelete() {
        const checkboxes = document.querySelectorAll('.chk-found:checked');
        const emailsToDelete = Array.from(checkboxes).map(cb => cb.value);

        if (emailsToDelete.length === 0) return Swal.fire({title:'Kosong', text:'Pilih data yang ingin dihapus.', icon:'warning', background: '#ffffff', color: '#000'});

        const confirm = await Swal.fire({title: 'Hapus Massal?', text: `Yakin menghapus ${emailsToDelete.length} data terpilih?`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Hapus', confirmButtonColor: '#FF3B30', background: '#ffffff', color: '#000'});

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Deleting...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
            const { error } = await _supabase.from('linked_users').delete().in('email', emailsToDelete);
            if (!error) {
                Swal.fire({title:'Sukses', text:'Data berhasil dihapus.', icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
                loadManageData(); loadStats(); scanMassData(); 
            }
        }
    }

    async function execMassInsert() {
        const checkboxes = document.querySelectorAll('.chk-new:checked');
        const emailsToInsert = Array.from(checkboxes).map(cb => cb.value);

        if (emailsToInsert.length === 0) return Swal.fire({title:'Kosong', text:'Pilih email baru yang ingin disimpan.', icon:'warning', background: '#ffffff', color: '#000'});

        const s = document.getElementById('massStatus').value;
        const r = document.getElementById('massReward').value || '0';
        const d = document.getElementById('massDate').value;

        if (!s) return Swal.fire({title:'Info', text:'Pilih Status awal untuk data baru.', icon:'info', background: '#ffffff', color: '#000'});

        const confirm = await Swal.fire({title: 'Simpan Massal?', text: `Akan menyimpan ${emailsToInsert.length} data baru terpilih.`, icon: 'question', showCancelButton: true, confirmButtonText: 'Ya, Simpan', confirmButtonColor: '#34C759', background: '#ffffff', color: '#000'});

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Saving...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
            
            const newPayload = emailsToInsert.map(email => ({
                email: email, status: s, reward: r,
                created_at: d ? new Date(d).toISOString() : new Date().toISOString()
            }));

            const { error } = await _supabase.from('linked_users').insert(newPayload);

            if (!error) {
                Swal.fire({title:'Sukses', text:'Data baru berhasil disimpan.', icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
                loadManageData(); loadStats(); scanMassData(); 
            } else {
                Swal.fire({title:'Gagal', text:error.message, icon:'error', background: '#ffffff', color: '#000'});
            }
        }
    }

    async function loadPaymentStats() {
        const { count: pendingCount } = await _supabase.from('linked_users').select('*', { count: 'exact', head: true }).eq('payment_status', 'claimed');
        const { count: paidCount } = await _supabase.from('linked_users').select('*', { count: 'exact', head: true }).eq('payment_status', 'paid');
        document.getElementById('stat-pending').innerText = pendingCount || 0;
        document.getElementById('stat-paid').innerText = paidCount || 0;
    }

    async function resetPaymentHistory() {
        const res = await Swal.fire({
            title: 'Reset SEMUA Histori?', 
            text: 'Data Pending (claimed), Selesai (paid), dan Ditolak (rejected) akan diarsipkan (dihapus dari view ini).', 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#FF3B30', 
            cancelButtonColor: '#d1d1d6', 
            confirmButtonText: 'Ya, Reset Semua', 
            background: '#ffffff', 
            color: '#000'
        });

        if (res.isConfirmed) {
            Swal.fire({ title: 'Mereset...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
            
            const { error } = await _supabase
                .from('linked_users')
                .update({ payment_status: 'archived' })
                .in('payment_status', ['claimed', 'paid', 'rejected']);
                
            if (error) { Swal.fire({title: 'Error', text: error.message, icon: 'error', background: '#ffffff', color: '#000'}); } 
            else {
                Swal.fire({title: 'Sukses', text: 'Semua histori payment berhasil direset.', icon: 'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
                loadPaymentStats(); 
                loadPaymentTracking(); 
            }
        }
    }

    // SARAN 1: LOGIKA WARNA BADGE BANK
    function getBankBadge(bankName) {
        if(!bankName) return `<span class="bank-badge bank-default"><i class="fa-solid fa-building-columns"></i> -</span>`;
        let name = bankName.toLowerCase();
        let icon = '<i class="fa-solid fa-building-columns"></i>';
        let cls = 'bank-default';

        if(name.includes('bca')) { cls = 'bank-bca'; }
        else if(name.includes('dana')) { cls = 'bank-dana'; icon = '<i class="fa-solid fa-wallet"></i>'; }
        else if(name.includes('ovo')) { cls = 'bank-ovo'; icon = '<i class="fa-solid fa-wallet"></i>'; }
        else if(name.includes('gopay') || name.includes('go-pay')) { cls = 'bank-gopay'; icon = '<i class="fa-solid fa-wallet"></i>'; }
        else if(name.includes('mandiri')) { cls = 'bank-mandiri'; }
        else if(name.includes('bri')) { cls = 'bank-bri'; }
        else if(name.includes('bni')) { cls = 'bank-bni'; }
        else if(name.includes('seabank') || name.includes('sea bank')) { cls = 'bank-seabank'; }
        else if(name.includes('shopee') || name.includes('spay')) { cls = 'bank-seabank'; icon = '<i class="fa-solid fa-wallet"></i>'; }

        return `<span class="bank-badge ${cls}" style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:10px; font-size:0.8rem; font-weight:700;">${icon} ${bankName}</span>`;
    }

    async function loadPaymentTracking() {
        const container = document.getElementById('paymentFocusContainer');
        container.innerHTML = '<p style="text-align:center;color:var(--theme-gray);">Loading...</p>';
        loadPaymentStats();
        
        const { data, error } = await _supabase.from('linked_users').select('*').eq('payment_status', 'claimed').order('withdraw_date', { ascending: true }); 
            
        if(error || !data || data.length === 0) {
            container.innerHTML = '<p class="slide-up-item" style="text-align:center; color:var(--theme-gray); margin-top:30px;">Tidak ada antrian transfer.</p>';
            paymentQueue = []; 
            initialQueueCount = 0; completedQueueCount = 0;
            return;
        }

        paymentQueue = data; 
        initialQueueCount = data.length; 
        completedQueueCount = 0;
        renderActivePayment();
    }

    // SARAN 3 & 5: RENDER TUMPUKAN KARTU DAN PROGRESS BAR
    function renderActivePayment() {
        const container = document.getElementById('paymentFocusContainer');
        
        if (paymentQueue.length === 0) { 
            container.innerHTML = `
                <div style="width: 100%; position: relative;">
                    <div class="queue-progress-text">Progress Hari Ini: ${completedQueueCount} Selesai</div>
                    <div class="queue-progress-container"><div class="queue-progress-bar" style="width: 100%;"></div></div>
                </div>
                <p class="slide-up-item" style="text-align:center; color:var(--theme-gray); margin-top:30px;">Semua antrian selesai! ðŸŽ‰</p>`; 
            return; 
        }

        const x = paymentQueue[0];
        let wn = (x.whatsapp||'').replace(/\D/g,''); if(wn.startsWith('0')) wn='62'+wn.slice(1); if(!wn.startsWith('62')) wn='62'+wn;
        const msg = `Halo, Penarikan reward LinkedIn senilai Rp ${x.reward} ke ${x.bank_name} (${x.acc_number}) a.n ${x.acc_name} SUDAH BERHASIL DITRANSFER. Terima kasih telah bekerjasama dengan Zen!`;
        const waLink = `https://wa.me/${wn}?text=${encodeURIComponent(msg)}`;
        
        const badgeHtml = getBankBadge(x.bank_name);
        let progressPct = initialQueueCount > 0 ? (completedQueueCount / initialQueueCount) * 100 : 0;

        let nextCardsHtml = '';
        if(paymentQueue.length > 1) nextCardsHtml += `<div class="payment-card-next"></div>`;
        if(paymentQueue.length > 2) nextCardsHtml += `<div class="payment-card-next-2"></div>`;

        container.innerHTML = `
            <div style="width: 100%; z-index: 5; position: relative;">
                <div class="queue-progress-text">Progress Hari Ini: ${completedQueueCount} dari ${initialQueueCount} Selesai</div>
                <div class="queue-progress-container"><div class="queue-progress-bar" style="width: ${progressPct}%;"></div></div>
            </div>

            <div style="position: relative; width: 100%; min-height: 280px; margin-top: 10px;">
                ${nextCardsHtml}
                
                <div class="payment-card-focus slide-up-item" id="currentPaymentCard">
                    <div class="stamp-status" id="paymentStamp">PAID</div>
                    
                    <div class="pcf-queue">Antrian (Sisa: ${paymentQueue.length})</div>
                    <div class="pcf-header">
                        ${badgeHtml}
                        <div class="pcf-amount">Rp ${x.reward}</div>
                    </div>
                    <div class="pcf-row"><div class="pcf-label"><i class="fa-solid fa-user"></i> Nama Pemilik</div><div class="pcf-val">${x.acc_name}</div></div>
                    <div class="pcf-row"><div class="pcf-label"><i class="fa-solid fa-credit-card"></i> Nomor Rekening</div><div class="pcf-val">${x.acc_number} <button onclick="copyText('${x.acc_number}')" class="copy-btn"><i class="fa-regular fa-copy"></i> Salin</button></div></div>
                    <div class="pcf-row"><div class="pcf-label"><i class="fa-solid fa-envelope"></i> Email User</div><div class="pcf-val" style="font-size:0.85rem; font-weight:400; color:var(--text-sec);">${x.email}</div></div>
                    
                    <div class="pcf-actions" style="gap:8px;">
                         <button onclick="rejectPayment(${x.id}, '${wn}', ${x.reward})" class="btn btn-reject" style="flex:1; font-size:0.85rem; padding:12px;">Tolak</button>
                        <button onclick="skipPayment()" class="btn btn-skip" style="flex:1; font-size:0.85rem; padding:12px;">Lewati</button>
                        <button onclick="markAsPaid(${x.id}, '${waLink}')" class="btn btn-done" style="flex:2; font-size:0.85rem; padding:12px;">Transfer</button>
                    </div>
                </div>
            </div>`;
    }

    // SARAN 4: ANIMASI SKIP, PAID, REJECT
    function skipPayment() {
        if(paymentQueue.length > 1) {
            const card = document.getElementById('currentPaymentCard');
            card.classList.add('slide-out-bottom'); // Animasi melorot ke bawah

            setTimeout(() => {
                const item = paymentQueue.shift(); 
                paymentQueue.push(item); // Taruh di belakang antrian
                renderActivePayment();
            }, 400);
        } else { 
            Swal.fire({toast: true, position: 'center', icon: 'info', title: 'Hanya ada 1 antrian', showConfirmButton: false, timer: 1000, background: '#ffffff', color: '#000'}); 
        }
    }

    async function rejectPayment(id, waNum, amount) {
        const { value: reason } = await Swal.fire({title: 'Tolak Penarikan?', input: 'text', inputLabel: 'Alasan Penolakan', inputPlaceholder: 'Misal: Nomor rekening salah...', showCancelButton: true, confirmButtonColor: '#FF3B30', cancelButtonColor: '#d1d1d6', confirmButtonText: 'Tolak & WA', background: '#ffffff', color: '#000', inputValidator: (value) => { if (!value) return 'Alasan wajib diisi!' }});

        if (reason) {
            const { error } = await _supabase.from('linked_users').update({ payment_status: 'rejected' }).eq('id', id);
            if(error) { Swal.fire({title:'Error', text:error.message, icon:'error', background: '#ffffff', color: '#000'}); return; }
            
            const msg = `Halo, Maaf permintaan penarikan reward Rp ${amount} DITOLAK. Alasan: ${reason}. Silakan cek data Anda kembali.`;
            const link = `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`;
            window.open(link, '_blank');
            
            loadPaymentStats();

            // Animasi Stempel Merah & Geser ke Kiri
            const card = document.getElementById('currentPaymentCard');
            const stamp = document.getElementById('paymentStamp');
            stamp.innerText = 'REJECT';
            stamp.style.color = 'rgba(255, 59, 48, 0.9)';
            stamp.style.borderColor = 'rgba(255, 59, 48, 0.9)';
            stamp.style.animation = 'stampAnim 0.8s forwards';
            
            setTimeout(() => { card.classList.add('slide-out-left'); }, 400);
            setTimeout(() => {
                paymentQueue.shift(); 
                completedQueueCount++;
                renderActivePayment(); 
            }, 800);
        }
    }

    async function markAsPaid(id, waLink) {
        const result = await Swal.fire({title: 'Konfirmasi Transfer', text: "Pastikan dana sudah dikirim sebelum menekan Ya.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Sudah Transfer', confirmButtonColor: '#0A84FF', cancelButtonColor: '#d1d1d6', background: '#ffffff', color: '#000'});

        if (result.isConfirmed) {
            const { error } = await _supabase.from('linked_users').update({ payment_status: 'paid' }).eq('id', id);
            if (error) { Swal.fire({title:'Error', text:error.message, icon:'error', background: '#ffffff', color: '#000'}); } 
            else { 
                window.open(waLink, '_blank'); 
                loadPaymentStats(); 
                
                // Animasi Stempel Hijau & Geser ke Kanan
                const card = document.getElementById('currentPaymentCard');
                const stamp = document.getElementById('paymentStamp');
                stamp.innerText = 'PAID';
                stamp.style.color = 'rgba(52, 199, 89, 0.9)';
                stamp.style.borderColor = 'rgba(52, 199, 89, 0.9)';
                stamp.style.animation = 'stampAnim 0.8s forwards';
                
                setTimeout(() => { card.classList.add('slide-out-right'); }, 400);
                setTimeout(() => {
                    paymentQueue.shift(); 
                    completedQueueCount++;
                    renderActivePayment(); 
                }, 800);
            }
        }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, background: '#ffffff', color: '#000'});
            Toast.fire({icon: 'success', title: 'Disalin!'});
        });
    }

    // --- FITUR BARU: COPY EMAILS BY STATUS (DIPERBAIKI) ---
    async function copyEmailsByStatus() {
        const target = document.getElementById('copyStatusTarget').value;
        Swal.fire({ title: 'Menyalin...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
        
        // FIX 1: Tambahkan .limit() yang besar untuk memastikan semua data terambil (default supabase cuma 1000)
        let query = _supabase.from('linked_users').select('email').limit(5000);
        
        if (target !== 'ALL') { 
            // FIX 2: Ganti .eq() menjadi .ilike()
            // .eq() -> Harus persis sama (Old Acc != old acc)
            // .ilike() -> Tidak peduli huruf besar/kecil (Old Acc == old acc == OLD ACC)
            query = query.ilike('status', target); 
        }

        const { data, error } = await query;
        
        if (error) { Swal.fire({title:'Error', text:error.message, icon:'error', background: '#ffffff', color: '#000'}); return; }
        if (!data || data.length === 0) { Swal.fire({title:'Kosong', text:'Tidak ada data untuk status ini.', icon:'info', background: '#ffffff', color: '#000'}); return; }

        // FIX 3: Tambahkan filter unik untuk membuang email yang duplikat (jika ada)
        const uniqueEmails = [...new Set(data.map(u => u.email))];
        const emailList = uniqueEmails.join('\n');

        navigator.clipboard.writeText(emailList).then(() => {
            Swal.fire({title:'Sukses', text:`${uniqueEmails.length} email berhasil disalin!`, icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
        });
    }

    // --- FITUR BARU: UPDATE REWARD MASSAL BY STATUS ---
    async function updateRewardByStatus() {
        const target = document.getElementById('rewardStatusTarget').value;
        const amount = document.getElementById('massRewardValue').value;
        
        if (!target) return Swal.fire({title:'Pilih Status', text:'Pilih status target terlebih dahulu.', icon:'warning', background: '#ffffff', color: '#000'});
        if (!amount) return Swal.fire({title:'Isi Nominal', text:'Isi nominal reward baru.', icon:'warning', background: '#ffffff', color: '#000'});

        const confirm = await Swal.fire({title: 'Yakin Update Massal?', text: `Semua user dengan status "${target}" akan diubah reward-nya menjadi Rp ${amount}. Tindakan ini tidak bisa dibatalkan!`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Ubah Semua', confirmButtonColor: '#FF3B30', cancelButtonColor: '#d1d1d6', background: '#ffffff', color: '#000'});

        if (confirm.isConfirmed) {
            Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });
            const { error } = await _supabase.from('linked_users').update({ reward: amount }).eq('status', target);
            if (error) { Swal.fire({title:'Error', text: error.message, icon:'error', background: '#ffffff', color: '#000'}); } 
            else {
                Swal.fire({title:'Berhasil', text:'Reward berhasil diupdate secara massal.', icon:'success', background: '#ffffff', color: '#000', confirmButtonColor: '#0A84FF'});
                loadManageData(); 
            }
        }
    }

    // ==========================================
    // FITUR HISTORY WITHDRAW (BARU)
    // ==========================================
    
    let isHistoryMode = false;
    let historyCache = []; // [NEW] Cache untuk pencarian lokal

    function toggleHistoryView() {
        const mainView = document.getElementById('paymentMainView');
        const histView = document.getElementById('paymentHistoryView');

        isHistoryMode = !isHistoryMode;

        if (isHistoryMode) {
            mainView.classList.add('hidden');
            histView.classList.remove('hidden');
            loadWithdrawHistory();
        } else {
            histView.classList.add('hidden');
            mainView.classList.remove('hidden');
        }
    }

    async function loadWithdrawHistory() {
        const list = document.getElementById('historyListContainer');
        list.innerHTML = '<p style="text-align:center; color:var(--theme-gray);">Memuat Riwayat...</p>';

        // Ambil data status 'paid' atau 'rejected', limit 100 terakhir
        const { data, error } = await _supabase
            .from('linked_users')
            .select('*')
            .in('payment_status', ['paid', 'rejected'])
            .order('withdraw_date', { ascending: false })
            .limit(100);

        if (error) {
            list.innerHTML = `<p style="text-align:center; color:var(--theme-red);">Gagal: ${error.message}</p>`;
            return;
        }

        if (!data || data.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:var(--theme-gray);">Belum ada riwayat (Paid/Rejected).</p>';
            return;
        }

        historyCache = data; // [NEW] Simpan ke cache
        renderHistoryList(historyCache); // [NEW] Render awal
    }

    // [NEW] Fungsi Render List (Dipisah agar bisa dipanggil ulang saat filter)
    function renderHistoryList(data) {
        const list = document.getElementById('historyListContainer');
        if (!data || data.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:var(--theme-gray);">Data tidak ditemukan.</p>';
            return;
        }

        let html = '';
        data.forEach(item => {
            const date = new Date(item.withdraw_date).toLocaleDateString() + ' ' + new Date(item.withdraw_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const statusClass = item.payment_status === 'paid' ? 'paid' : 'rejected';
            const statusLabel = item.payment_status === 'paid' ? 'BERHASIL' : 'DITOLAK';

            html += `
            <div class="hist-item slide-up-item">
                <div class="hist-header">
                    <span class="hist-date">${date}</span>
                    <span class="hist-status ${statusClass}">${statusLabel}</span>
                </div>
                <div style="margin-bottom:4px;">
                    <span class="hist-name">${item.acc_name}</span>
                    <span class="hist-amount">Rp ${item.reward}</span>
                </div>
                <div style="font-size:0.8rem; color:var(--text-sec); display:flex; justify-content:space-between;">
                    <span><span class="hist-bank">${item.bank_name}</span> ${item.acc_number}</span>
                </div>
                <div style="font-size:0.75rem; color:var(--theme-gray); margin-top:4px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${item.email}</span>
                    <span><i class="fa-brands fa-whatsapp" style="color:#25D366; margin-right:4px;"></i>${item.whatsapp || '-'}</span>
                </div>
            </div>`;
        });

        list.innerHTML = html;
    }

    // [NEW] Fungsi Filter Search
    function filterHistory() {
        const q = document.getElementById('historySearchInput').value.toLowerCase();
        
        const filtered = historyCache.filter(item => {
            return (item.email && item.email.toLowerCase().includes(q)) ||
                   (item.acc_name && item.acc_name.toLowerCase().includes(q)) ||
                   (item.bank_name && item.bank_name.toLowerCase().includes(q));
        });

        renderHistoryList(filtered);
    }

    // [NEW] Function untuk tombol Ubah Data WA
    function requestDataChange() {
        if(!currentUserData) return;
        const phone = '6289513304878';
        const text = `Halo Admin, saya ingin mengajukan perubahan data rekening/e-wallet untuk email: ${currentUserData.email}`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank');
    }

    // ==========================================
    // FITUR BULLETIN BOARD SLIDER & CLOUDINARY
    // ==========================================
    let bulletinList = [];
    let currentBulletinIndex = 0;
    let bulletinInterval = null;

    async function loadBulletin() {
        // Ambil 10 pengumuman terbaru
        const { data, error } = await _supabase.from('bulletin_board').select('*').order('created_at', { ascending: false }).limit(10);
        
        if (data && data.length > 0) {
            bulletinList = data;
            document.getElementById('bulletinArea').classList.remove('hidden');
            currentBulletinIndex = 0;
            renderCurrentBulletin();
            
            // Bersihkan interval lama jika ada
            if(bulletinInterval) clearInterval(bulletinInterval);
            
            // Buat slider otomatis jika ada lebih dari 1 pengumuman
            if (bulletinList.length > 1) {
                bulletinInterval = setInterval(() => {
                    currentBulletinIndex = (currentBulletinIndex + 1) % bulletinList.length;
                    renderCurrentBulletin();
                }, 5000); // Ganti tiap 5 detik
            }
        } else {
            document.getElementById('bulletinArea').classList.add('hidden');
            if(bulletinInterval) clearInterval(bulletinInterval);
        }
    }

    function renderCurrentBulletin() {
        const item = bulletinList[currentBulletinIndex];
        if (!item) return;

        const contentSlider = document.getElementById('bulletinContentSlider');
        
        // Reset animasi (Trick membuang dan memasang class ulang agar transisi jalan lagi)
        contentSlider.classList.remove('bulletin-fade');
        void contentSlider.offsetWidth; 
        contentSlider.classList.add('bulletin-fade');

        document.getElementById('bulletinText').innerText = item.content || '';
        
        const imgEl = document.getElementById('bulletinImgDisplay');
        if(item.image_url) {
            imgEl.src = item.image_url;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
            imgEl.src = '';
        }

        const date = new Date(item.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        // Tambahkan indikator angka misal (1/3)
        let indicator = bulletinList.length > 1 ? ` (${currentBulletinIndex + 1}/${bulletinList.length})` : '';
        document.getElementById('bulletinDate').innerText = "Update: " + date + indicator;
    }

    function openAllBulletinsModal() {
        const container = document.getElementById('allBulletinsContainer');
        container.innerHTML = '';

        bulletinList.forEach((item, index) => {
            const date = new Date(item.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' });
            
            // Render gambar jika ada, dengan efek klik perbesar
            let imgHtml = item.image_url ? `<img src="${item.image_url}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; margin-top: 8px; border: 1px solid rgba(0,0,0,0.05); cursor: zoom-in;" onclick="event.stopPropagation(); openImageModal('${item.image_url}')">` : '';

            container.innerHTML += `
                <div class="bulletin-item-full slide-up-item" style="animation-delay: ${index * 0.05}s">
                    <div style="font-size: 0.9rem; color: var(--text-main); line-height: 1.5; word-wrap: break-word;">${item.content}</div>
                    ${imgHtml}
                    <div style="font-size: 0.7rem; color: var(--theme-gray); margin-top: 8px;">${date}</div>
                </div>
            `;
        });

        document.getElementById('allBulletinsModal').classList.add('active');
    }

    function closeAllBulletinsModal() {
        document.getElementById('allBulletinsModal').classList.remove('active');
    }

    async function postBulletin() {
        const content = document.getElementById('bulletinInput').value.trim();
        const imageFile = document.getElementById('bulletinImage').files[0];

        if (!content && !imageFile) return Swal.fire({title:'Error', text:'Isi pengumuman atau pilih gambar!', icon:'warning', background:'#ffffff', color:'#000'});
        
        Swal.fire({ title: 'Memposting...', didOpen: () => Swal.showLoading(), background: '#ffffff', color: '#000' });

        let imageUrl = null;

        // 1. Upload ke Cloudinary jika ada file gambar
        if (imageFile) {
            const formData = new FormData();
            formData.append('file', imageFile);
            formData.append('upload_preset', 'xv0tqoe8');
            
            try {
                const res = await fetch('https://api.cloudinary.com/v1_1/dsuk4te3f/image/upload', {
                    method: 'POST',
                    body: formData
                });
                const cloudData = await res.json();
                
                if (cloudData.secure_url) {
                    imageUrl = cloudData.secure_url;
                } else {
                    throw new Error("Gagal mendapatkan link dari Cloudinary.");
                }
            } catch (err) {
                return Swal.fire({title:'Gagal Upload Gambar', text: err.message, icon:'error', background:'#ffffff', color:'#000'});
            }
        }

        // HAPUS logika "is_active: false" agar pengumuman lama tidak dimatikan, jadi bisa masuk ke dalam list/slider.
        
        // 2. Simpan data baru ke Supabase
        const payload = { content: content || ' ', is_active: true };
        if (imageUrl) payload.image_url = imageUrl;

        const { error } = await _supabase.from('bulletin_board').insert([payload]);
        
        if (!error) {
            Swal.fire({icon: 'success', title: 'Berhasil!', background: '#ffffff', color: '#000'});
            document.getElementById('bulletinInput').value = '';
            document.getElementById('bulletinImage').value = '';
            loadAdminBulletin(); 
            loadBulletin(); 
        } else {
            Swal.fire({title:'Gagal Menyimpan Database', text: error.message, icon:'error', background:'#ffffff', color:'#000'});
        }
    }

    async function loadAdminBulletin() {
        const list = document.getElementById('adminBulletinList');
        list.innerHTML = '<p style="text-align:center; color:var(--theme-gray);">Loading...</p>';
        const { data, error } = await _supabase.from('bulletin_board').select('*').order('created_at', { ascending: false });
        
        if (data && data.length > 0) {
            let html = '';
            data.forEach(item => {
                let imgThumb = item.image_url ? `<img src="${item.image_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 12px; flex-shrink: 0; cursor: zoom-in;" onclick="openImageModal('${item.image_url}')">` : '';
                
                html += `
                <div class="admin-bulletin-item" style="display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                        ${imgThumb}
                        <div style="font-size:0.85rem; word-wrap:break-word; flex: 1;">${item.content}</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 8px;">
                        <span style="font-size:0.7rem; color:var(--theme-gray);">${new Date(item.created_at).toLocaleString('id-ID')}</span>
                        <button class="btn btn-danger btn-sm" onclick="deleteBulletin(${item.id})" style="padding:4px 10px; font-size:0.7rem; width:auto;">Hapus</button>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        } else {
            list.innerHTML = '<p style="text-align:center; color:var(--theme-gray);">Belum ada riwayat pengumuman.</p>';
        }
    }

    async function deleteBulletin(id) {
        const confirm = await Swal.fire({title: 'Hapus Pengumuman?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#FF3B30', cancelButtonColor: '#d1d1d6', confirmButtonText: 'Ya, Hapus', background: '#ffffff', color: '#000'});
        
        if (confirm.isConfirmed) {
            const { error } = await _supabase.from('bulletin_board').delete().eq('id', id);
            if (!error) { 
                loadAdminBulletin(); 
                loadBulletin(); 
            }
        }
    }

</script>
</body>
</html>
